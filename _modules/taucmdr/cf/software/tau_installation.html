<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>taucmdr.cf.software.tau_installation &mdash; TAU Commander Developer Documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '1.3.0.99
',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="top" title="TAU Commander Developer Documentation" href="../../../../index.html" />
    <link rel="up" title="taucmdr.cf.software" href="../software.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><img class="rightlogo" src="../../../../_static/taulogo-large.png" alt="Logo"/><h1 class="heading"><a href="../../../../index.html">
          <span>TAU Commander Developer Documentation</span></a></h1>
        <h2 class="heading"><span>taucmdr.cf.software.tau_installation</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for taucmdr.cf.software.tau_installation</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2015, ParaTools, Inc.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1"># (1) Redistributions of source code must retain the above copyright notice,</span>
<span class="c1">#     this list of conditions and the following disclaimer.</span>
<span class="c1"># (2) Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#     this list of conditions and the following disclaimer in the documentation</span>
<span class="c1">#     and/or other materials provided with the distribution.</span>
<span class="c1"># (3) Neither the name of ParaTools, Inc. nor the names of its contributors may</span>
<span class="c1">#     be used to endorse or promote products derived from this software without</span>
<span class="c1">#     specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c1"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c1"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="c1"># DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span>
<span class="c1"># FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="c1"># DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span class="c1"># SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<span class="c1"># CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="c1"># OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="c1"># OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;TAU software installation management.</span>

<span class="sd">TAU is the core software package of TAU Commander.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Settle down pylint.  This is a big, ugly file and there&#39;s not much we can do about it.</span>
<span class="c1"># pylint: disable=too-many-instance-attributes</span>
<span class="c1"># pylint: disable=too-many-arguments</span>
<span class="c1"># pylint: disable=too-many-locals</span>
<span class="c1"># pylint: disable=too-many-statements</span>
<span class="c1"># pylint: disable=too-many-lines</span>
<span class="c1"># pylint: disable=too-many-branches</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">resource</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">CalledProcessError</span>
<span class="kn">from</span> <span class="nn">taucmdr</span> <span class="kn">import</span> <span class="n">logger</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">taucmdr.error</span> <span class="kn">import</span> <span class="n">ConfigurationError</span><span class="p">,</span> <span class="n">InternalError</span>
<span class="kn">from</span> <span class="nn">taucmdr.cf.software</span> <span class="kn">import</span> <span class="n">SoftwarePackageError</span>
<span class="kn">from</span> <span class="nn">taucmdr.cf.software.installation</span> <span class="kn">import</span> <span class="n">Installation</span><span class="p">,</span> <span class="n">parallel_make_flags</span><span class="p">,</span> <span class="n">new_os_environ</span>
<span class="kn">from</span> <span class="nn">taucmdr.cf.compiler</span> <span class="kn">import</span> <span class="n">host</span> <span class="k">as</span> <span class="n">host_compilers</span><span class="p">,</span> <span class="n">InstalledCompilerSet</span>
<span class="kn">from</span> <span class="nn">taucmdr.cf.compiler.host</span> <span class="kn">import</span> <span class="n">CC</span><span class="p">,</span> <span class="n">CXX</span><span class="p">,</span> <span class="n">FC</span><span class="p">,</span> <span class="n">UPC</span><span class="p">,</span> <span class="n">GNU</span><span class="p">,</span> <span class="n">APPLE_LLVM</span><span class="p">,</span> <span class="n">IBM</span>
<span class="kn">from</span> <span class="nn">taucmdr.cf.compiler.mpi</span> <span class="kn">import</span> <span class="n">MPI_CC</span><span class="p">,</span> <span class="n">MPI_CXX</span><span class="p">,</span> <span class="n">MPI_FC</span>
<span class="kn">from</span> <span class="nn">taucmdr.cf.compiler.shmem</span> <span class="kn">import</span> <span class="n">SHMEM_CC</span><span class="p">,</span> <span class="n">SHMEM_CXX</span><span class="p">,</span> <span class="n">SHMEM_FC</span>
<span class="kn">from</span> <span class="nn">taucmdr.cf.compiler.cuda</span> <span class="kn">import</span> <span class="n">CUDA_CXX</span><span class="p">,</span> <span class="n">CUDA_FC</span>
<span class="kn">from</span> <span class="nn">taucmdr.cf.compiler.caf</span> <span class="kn">import</span> <span class="n">CAF_FC</span>
<span class="kn">from</span> <span class="nn">taucmdr.cf.platforms</span> <span class="kn">import</span> <span class="n">TauMagic</span><span class="p">,</span> <span class="n">DARWIN</span><span class="p">,</span> <span class="n">CRAY_CNL</span><span class="p">,</span> <span class="n">IBM_BGL</span><span class="p">,</span> <span class="n">IBM_BGP</span><span class="p">,</span> <span class="n">IBM_BGQ</span><span class="p">,</span> <span class="n">HOST_ARCH</span><span class="p">,</span> <span class="n">HOST_OS</span>
<span class="kn">from</span> <span class="nn">taucmdr.cf.platforms</span> <span class="kn">import</span> <span class="n">INTEL_KNL</span><span class="p">,</span> <span class="n">INTEL_KNC</span>


<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">REPOS</span> <span class="o">=</span> <span class="p">{</span><span class="bp">None</span><span class="p">:</span> <span class="s1">&#39;http://tau.uoregon.edu/tau.tgz&#39;</span><span class="p">}</span>

<span class="n">NIGHTLY</span> <span class="o">=</span> <span class="s1">&#39;http://fs.paratools.com/tau-nightly.tgz&#39;</span>

<span class="n">DATA_TOOLS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;jumpshot&#39;</span><span class="p">,</span>
              <span class="s1">&#39;paraprof&#39;</span><span class="p">,</span>
              <span class="s1">&#39;perfdmf_configure&#39;</span><span class="p">,</span>
              <span class="s1">&#39;perfdmf_createapp&#39;</span><span class="p">,</span>
              <span class="s1">&#39;perfdmf_createexp&#39;</span><span class="p">,</span>
              <span class="s1">&#39;perfdmfdb.py&#39;</span><span class="p">,</span>
              <span class="s1">&#39;perfdmf_loadtrial&#39;</span><span class="p">,</span>
              <span class="s1">&#39;perfexplorer&#39;</span><span class="p">,</span>
              <span class="s1">&#39;perfexplorer_configure&#39;</span><span class="p">,</span>
              <span class="s1">&#39;pprof&#39;</span><span class="p">,</span>
              <span class="s1">&#39;slog2print&#39;</span><span class="p">,</span>
              <span class="s1">&#39;tau2slog2&#39;</span><span class="p">,</span>
              <span class="s1">&#39;taudb_configure&#39;</span><span class="p">,</span>
              <span class="s1">&#39;taudb_install_cert&#39;</span><span class="p">,</span>
              <span class="s1">&#39;taudb_keygen&#39;</span><span class="p">,</span>
              <span class="s1">&#39;taudb_loadtrial&#39;</span><span class="p">,</span>
              <span class="s1">&#39;tau_ebs2otf.pl&#39;</span><span class="p">,</span>
              <span class="s1">&#39;tau_ebs_process.pl&#39;</span><span class="p">,</span>
              <span class="s1">&#39;tau_merge&#39;</span><span class="p">,</span>
              <span class="s1">&#39;tau_multimerge&#39;</span><span class="p">,</span>
              <span class="s1">&#39;tau_treemerge.pl&#39;</span><span class="p">,</span>
              <span class="s1">&#39;tau_treemerge.pl&#39;</span><span class="p">]</span>

<span class="n">COMMANDS</span> <span class="o">=</span> <span class="p">{</span><span class="bp">None</span><span class="p">:</span>
            <span class="n">DATA_TOOLS</span> <span class="o">+</span> 
            <span class="p">[</span><span class="s1">&#39;phaseconvert&#39;</span><span class="p">,</span>
             <span class="s1">&#39;ppscript&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_analyze&#39;</span><span class="p">,</span>
             <span class="s1">&#39;taucc&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_cc.sh&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_compiler.sh&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau-config&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_convert&#39;</span><span class="p">,</span>
             <span class="s1">&#39;taucxx&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_cxx.sh&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tauex&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_exec&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_f77.sh&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tauf90&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_f90.sh&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_gen_wrapper&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_header_replace.pl&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tauinc.pl&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_java&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_javamax.sh&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_macro.sh&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_pebil_rewrite&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_reduce&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_rewrite&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_selectfile&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_show_libs&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_throttle.sh&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tauupc&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_upc.sh&#39;</span><span class="p">,</span>
             <span class="s1">&#39;tau_user_setup.sh&#39;</span><span class="p">]}</span>

<span class="n">HEADERS</span> <span class="o">=</span> <span class="p">{</span><span class="bp">None</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Profile/Profiler.h&#39;</span><span class="p">,</span> <span class="s1">&#39;Profile/TAU.h&#39;</span><span class="p">]}</span>

<span class="n">TAU_COMPILER_WRAPPERS</span> <span class="o">=</span> <span class="p">{</span><span class="n">CC</span><span class="p">:</span> <span class="s1">&#39;tau_cc.sh&#39;</span><span class="p">,</span>
                         <span class="n">CXX</span><span class="p">:</span> <span class="s1">&#39;tau_cxx.sh&#39;</span><span class="p">,</span>
                         <span class="n">FC</span><span class="p">:</span> <span class="s1">&#39;tau_f90.sh&#39;</span><span class="p">,</span>
                         <span class="n">UPC</span><span class="p">:</span> <span class="s1">&#39;tau_upc.sh&#39;</span><span class="p">,</span>
                         <span class="n">MPI_CC</span><span class="p">:</span> <span class="s1">&#39;tau_cc.sh&#39;</span><span class="p">,</span>
                         <span class="n">MPI_CXX</span><span class="p">:</span> <span class="s1">&#39;tau_cxx.sh&#39;</span><span class="p">,</span>
                         <span class="n">MPI_FC</span><span class="p">:</span> <span class="s1">&#39;tau_f90.sh&#39;</span><span class="p">,</span>
                         <span class="n">SHMEM_CC</span><span class="p">:</span> <span class="s1">&#39;tau_cc.sh&#39;</span><span class="p">,</span>
                         <span class="n">SHMEM_CXX</span><span class="p">:</span> <span class="s1">&#39;tau_cxx.sh&#39;</span><span class="p">,</span>
                         <span class="n">SHMEM_FC</span><span class="p">:</span> <span class="s1">&#39;tau_f90.sh&#39;</span><span class="p">,</span>
                         <span class="n">CUDA_CXX</span><span class="p">:</span> <span class="s1">&#39;tau_cxx.sh&#39;</span><span class="p">,</span>
                         <span class="n">CUDA_FC</span><span class="p">:</span> <span class="s1">&#39;tau_ftn.sh&#39;</span><span class="p">,</span>
                         <span class="n">CAF_FC</span><span class="p">:</span> <span class="s1">&#39;tau_caf.sh&#39;</span><span class="p">}</span>

<span class="n">TAU_MINIMAL_COMPILERS</span> <span class="o">=</span> <span class="p">[</span><span class="n">CC</span><span class="p">,</span> <span class="n">CXX</span><span class="p">]</span>

<span class="n">PROFILE_ANALYSIS_TOOLS</span> <span class="o">=</span> <span class="s1">&#39;paraprof&#39;</span><span class="p">,</span> <span class="s1">&#39;pprof&#39;</span>

<span class="n">TRACE_ANALYSIS_TOOLS</span> <span class="o">=</span> <span class="s1">&#39;jumpshot&#39;</span><span class="p">,</span> <span class="s1">&#39;vampir&#39;</span>

<span class="n">PROGRAM_LAUNCHERS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mpirun&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;-app&#39;</span><span class="p">,</span> <span class="s1">&#39;--app&#39;</span><span class="p">,</span> <span class="s1">&#39;-configfile&#39;</span><span class="p">],</span> 
                     <span class="s1">&#39;mpiexec&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;-app&#39;</span><span class="p">,</span> <span class="s1">&#39;--app&#39;</span><span class="p">,</span> <span class="s1">&#39;-configfile&#39;</span><span class="p">],</span> 
                     <span class="s1">&#39;ibrun&#39;</span><span class="p">:</span> <span class="p">[],</span> 
                     <span class="s1">&#39;aprun&#39;</span><span class="p">:</span> <span class="p">[],</span> 
                     <span class="s1">&#39;qsub&#39;</span><span class="p">:</span> <span class="p">[],</span> 
                     <span class="s1">&#39;srun&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;--multi-prog&#39;</span><span class="p">],</span> 
                     <span class="s1">&#39;oshrun&#39;</span><span class="p">:</span> <span class="p">[],</span>
                     <span class="s1">&#39;cafrun&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;-np&#39;</span><span class="p">]}</span>


<div class="viewcode-block" id="TauInstallation"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation">[docs]</a><span class="k">class</span> <span class="nc">TauInstallation</span><span class="p">(</span><span class="n">Installation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Encapsulates a TAU installation.</span>

<span class="sd">    TAU is an enormous, organic, complex piece of software so this class is</span>
<span class="sd">    unusually complex to consider all the corner cases.  This is where most</span>
<span class="sd">    of the systemization of TAU is actually implemented so it can get ugly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">target_arch</span><span class="p">,</span> <span class="n">target_os</span><span class="p">,</span> <span class="n">compilers</span><span class="p">,</span>
                 <span class="c1"># Minimal configuration support</span>
                 <span class="n">minimal</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="c1"># TAU feature suppport</span>
                 <span class="n">application_linkage</span><span class="o">=</span><span class="s1">&#39;dynamic&#39;</span><span class="p">,</span>
                 <span class="n">openmp_support</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">pthreads_support</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">tbb_support</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">mpi_support</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">mpi_libraries</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">caf_support</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">cuda_support</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">cuda_prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">opencl_support</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">opencl_prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">shmem_support</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">shmem_libraries</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">mpc_support</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">max_threads</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="c1"># Instrumentation methods and options</span>
                 <span class="n">source_inst</span><span class="o">=</span><span class="s2">&quot;never&quot;</span><span class="p">,</span>
                 <span class="n">compiler_inst</span><span class="o">=</span><span class="s2">&quot;never&quot;</span><span class="p">,</span>
                 <span class="n">keep_inst_files</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">reuse_inst_files</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">select_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="c1"># Measurement methods and options</span>
                 <span class="n">baseline</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">profile</span><span class="o">=</span><span class="s2">&quot;tau&quot;</span><span class="p">,</span>
                 <span class="n">trace</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                 <span class="n">sample</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">metrics</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">measure_io</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">measure_mpi</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">measure_openmp</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
                 <span class="n">measure_opencl</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">measure_cuda</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">measure_shmem</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">measure_heap_usage</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">measure_system_load</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">measure_memory_alloc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">measure_comm_matrix</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">measure_callsite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">callpath_depth</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                 <span class="n">throttle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">metadata_merge</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">throttle_per_call</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">throttle_num_calls</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
                 <span class="n">track_memory_footprint</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">update_nightly</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">forced_makefile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">unwind_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the TAU installation wrapper class.</span>

<span class="sd">        Args:</span>
<span class="sd">            sources (dict): Packages sources as strings indexed by package names as strings.  A source may be a</span>
<span class="sd">                            path to a directory where the software has already been installed, or a path to a source</span>
<span class="sd">                            archive file, or the special keywords &#39;download&#39; or &#39;nightly&#39;.</span>
<span class="sd">            target_arch (Architecture): Target architecture description.</span>
<span class="sd">            target_os (OperatingSystem): Target operating system description.</span>
<span class="sd">            compilers (InstalledCompilerSet): Compilers to use if software must be compiled.</span>
<span class="sd">            minimal (bool): If True then ignore all other arguments and configure with minimal features.</span>
<span class="sd">            application_linkage (str): Either &quot;static&quot; or &quot;dynamic&quot;. </span>
<span class="sd">            openmp_support (bool): Enable or disable OpenMP support in TAU.</span>
<span class="sd">            pthreads_support (bool): Enable or disable pthreads support in TAU.</span>
<span class="sd">            tbb_support (bool): Enable or disable tbb support in TAU.</span>
<span class="sd">            mpi_support (bool): Enable or disable MPI support in TAU.</span>
<span class="sd">            mpi_libraries (list): MPI libraries to include when linking with TAU.</span>
<span class="sd">            cuda_support (bool): Enable or disable CUDA support in TAU.</span>
<span class="sd">            cuda_prefix (str): Path to CUDA toolkit installation.</span>
<span class="sd">            opencl_support (bool): Enable or disable OpenCL support in TAU.</span>
<span class="sd">            shmem_support (bool): Enable or disable SHMEM support in TAU.</span>
<span class="sd">            shmem_libraries (list): SHMEM libraries to include when linking with TAU.</span>
<span class="sd">            mpc_support (bool): Enable or disable MPC support in TAU.</span>
<span class="sd">            max_threads (int): Maximum number of threads in TAU.</span>
<span class="sd">            source_inst (str): Policy for source-based instrumentation, one of &quot;automatic&quot;, &quot;manual&quot;, or &quot;never&quot;.</span>
<span class="sd">            compiler_inst (str): Policy for compiler-based instrumentation, one of &quot;always&quot;, &quot;fallback&quot;, or &quot;never&quot;.</span>
<span class="sd">            keep_inst_files (bool): If True then do not remove instrumented source files after compilation.</span>
<span class="sd">            reuse_inst_files (bool): If True then reuse instrumented source files for compilation when available.</span>
<span class="sd">            select_file (str): Path to selective instrumentation file.</span>
<span class="sd">            baseline (bool): If True, only measure wallclock time via `tau_baseline`.</span>
<span class="sd">            profile (str): Format for profile files, one of &quot;tau&quot;, &quot;merged&quot;, &quot;cubex&quot;, or &quot;none&quot;.</span>
<span class="sd">            trace (str): Format for trace files, one of &quot;slog2&quot;, &quot;otf2&quot;, or &quot;none&quot;.</span>
<span class="sd">            sample (bool): Enable or disable event-based sampling.</span>
<span class="sd">            metrics (list): Metrics to measure, e.g. [&#39;TIME&#39;, &#39;PAPI_FP_INS&#39;]</span>
<span class="sd">            measure_io (bool): If True then measure time spent in POSIX I/O calls.</span>
<span class="sd">            measure_mpi (bool): If True then measure time spent in MPI calls.</span>
<span class="sd">            measure_openmp (str): String specifying OpenMP measurement method, one of &quot;ignore&quot;, &quot;ompt&quot;, or &quot;opari&quot;.</span>
<span class="sd">            measure_cuda (bool): If True then measure time spent in CUDA calls.</span>
<span class="sd">            measure_shmem (bool): If True then measure time spent in SHMEM calls.</span>
<span class="sd">            measure_heap_usage (bool): If True then measure memory usage.</span>
<span class="sd">            measure_system_load (bool): If True then measure the system load.</span>
<span class="sd">            measure_memory_alloc (bool): If True then record memory allocation and deallocation events.</span>
<span class="sd">            measure_comm_matrix (bool): If True then record the point-to-point communication matrix.</span>
<span class="sd">            measure_callsite (bool): If True then record event callsites.</span>
<span class="sd">            callpath_depth (int): Depth of callpath measurement.  0 to disable.</span>
<span class="sd">            throttle (bool): If True then throttle lightweight events.</span>
<span class="sd">            metadata_merge (bool): If True then merge metadata.</span>
<span class="sd">            update_nightly (bool): If True then download latest TAU nightly.</span>
<span class="sd">            throttle_per_call (int): Maximum microseconds per call of a lightweight event.</span>
<span class="sd">            throttle_num_calls (int): Minimum number of calls for a lightweight event.</span>
<span class="sd">            track_memory_footprint (bool): If True then track memory footprint.</span>
<span class="sd">            forced_makefile (str): Path to external makefile if forcing TAU_MAKEFILE or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">minimal</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">application_linkage</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;dynamic&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">openmp_support</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">pthreads_support</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">tbb_support</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">mpi_support</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mpi_libraries</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="n">mpi_libraries</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">cuda_support</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cuda_prefix</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cuda_prefix</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">opencl_support</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opencl_prefix</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">or</span> <span class="n">opencl_prefix</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">shmem_support</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shmem_libraries</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="n">shmem_libraries</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">mpc_support</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_threads</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">max_threads</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">source_inst</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;automatic&quot;</span><span class="p">,</span> <span class="s2">&quot;manual&quot;</span><span class="p">,</span> <span class="s2">&quot;never&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">compiler_inst</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;always&quot;</span><span class="p">,</span> <span class="s2">&quot;fallback&quot;</span><span class="p">,</span> <span class="s2">&quot;never&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">keep_inst_files</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">reuse_inst_files</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">select_file</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">or</span> <span class="n">select_file</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">baseline</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">profile</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;tau&quot;</span><span class="p">,</span> <span class="s2">&quot;merged&quot;</span><span class="p">,</span> <span class="s2">&quot;cubex&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">trace</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;slog2&quot;</span><span class="p">,</span> <span class="s2">&quot;otf2&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">sample</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">measure_io</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">measure_mpi</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">measure_openmp</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="s2">&quot;ompt&quot;</span><span class="p">,</span> <span class="s2">&quot;opari&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">measure_opencl</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">measure_cuda</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">measure_shmem</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">measure_heap_usage</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">measure_system_load</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">measure_memory_alloc</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">measure_comm_matrix</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">measure_callsite</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">callpath_depth</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">throttle</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">metadata_merge</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">update_nightly</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">throttle_per_call</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">throttle_num_calls</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">track_memory_footprint</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">forced_makefile</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">or</span> <span class="n">forced_makefile</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TauInstallation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;tau&#39;</span><span class="p">,</span> <span class="s1">&#39;TAU Performance System&#39;</span><span class="p">,</span> 
                                              <span class="n">sources</span><span class="p">,</span> <span class="n">target_arch</span><span class="p">,</span> <span class="n">target_os</span><span class="p">,</span> <span class="n">compilers</span><span class="p">,</span> 
                                              <span class="n">REPOS</span><span class="p">,</span> <span class="n">COMMANDS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tau_makefile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_install_tag</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_sources</span> <span class="o">=</span> <span class="n">sources</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">==</span> <span class="s1">&#39;nightly&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">NIGHTLY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_magic</span> <span class="o">=</span> <span class="n">TauMagic</span><span class="o">.</span><span class="n">find</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_os</span><span class="p">))</span>
        <span class="c1"># TAU puts installation files (bin, lib, etc.) in a magically named subfolder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bin_subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tau_magic</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;bin&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lib_subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tau_magic</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;lib&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">LOG_LEVEL</span> <span class="o">==</span> <span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimal</span> <span class="o">=</span> <span class="n">minimal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application_linkage</span> <span class="o">=</span> <span class="n">application_linkage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openmp_support</span> <span class="o">=</span> <span class="n">openmp_support</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opencl_support</span> <span class="o">=</span> <span class="n">opencl_support</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opencl_prefix</span> <span class="o">=</span> <span class="n">opencl_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pthreads_support</span> <span class="o">=</span> <span class="n">pthreads_support</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tbb_support</span> <span class="o">=</span> <span class="n">tbb_support</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpi_support</span> <span class="o">=</span> <span class="n">mpi_support</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpi_libraries</span> <span class="o">=</span> <span class="n">mpi_libraries</span> <span class="k">if</span> <span class="n">mpi_libraries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caf_support</span> <span class="o">=</span> <span class="n">caf_support</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cuda_support</span> <span class="o">=</span> <span class="n">cuda_support</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cuda_prefix</span> <span class="o">=</span> <span class="n">cuda_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shmem_support</span> <span class="o">=</span> <span class="n">shmem_support</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shmem_libraries</span> <span class="o">=</span> <span class="n">shmem_libraries</span> <span class="k">if</span> <span class="n">shmem_libraries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpc_support</span> <span class="o">=</span> <span class="n">mpc_support</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span> <span class="o">=</span> <span class="n">max_threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_inst</span> <span class="o">=</span> <span class="n">source_inst</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiler_inst</span> <span class="o">=</span> <span class="n">compiler_inst</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_inst_files</span> <span class="o">=</span> <span class="n">keep_inst_files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reuse_inst_files</span> <span class="o">=</span> <span class="n">reuse_inst_files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_file</span> <span class="o">=</span> <span class="n">select_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">sample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_io</span> <span class="o">=</span> <span class="n">measure_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_mpi</span> <span class="o">=</span> <span class="n">measure_mpi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_openmp</span> <span class="o">=</span> <span class="n">measure_openmp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_opencl</span> <span class="o">=</span> <span class="n">measure_opencl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_cuda</span> <span class="o">=</span> <span class="n">measure_cuda</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_shmem</span> <span class="o">=</span> <span class="n">measure_shmem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_heap_usage</span> <span class="o">=</span> <span class="n">measure_heap_usage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_system_load</span> <span class="o">=</span> <span class="n">measure_system_load</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_memory_alloc</span> <span class="o">=</span> <span class="n">measure_memory_alloc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_comm_matrix</span> <span class="o">=</span> <span class="n">measure_comm_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_callsite</span> <span class="o">=</span> <span class="n">measure_callsite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callpath_depth</span> <span class="o">=</span> <span class="n">callpath_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">throttle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_merge</span> <span class="o">=</span> <span class="n">metadata_merge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_nightly</span> <span class="o">=</span> <span class="n">update_nightly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">throttle_per_call</span> <span class="o">=</span> <span class="n">throttle_per_call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">throttle_num_calls</span> <span class="o">=</span> <span class="n">throttle_num_calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_memory_footprint</span> <span class="o">=</span> <span class="n">track_memory_footprint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forced_makefile</span> <span class="o">=</span> <span class="n">forced_makefile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unwind_depth</span> <span class="o">=</span> <span class="n">unwind_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uses_pdt</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">minimal</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_inst</span> <span class="o">==</span> <span class="s1">&#39;automatic&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">shmem_support</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uses_binutils</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">minimal</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_os</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DARWIN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uses_libunwind</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">minimal</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_os</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DARWIN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uses_papi</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">minimal</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">met</span> <span class="k">for</span> <span class="n">met</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="k">if</span> <span class="s1">&#39;PAPI&#39;</span> <span class="ow">in</span> <span class="n">met</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uses_scorep</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">minimal</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">==</span> <span class="s1">&#39;cubex&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uses_ompt</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">minimal</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measure_openmp</span> <span class="o">==</span> <span class="s1">&#39;ompt&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uses_ompt_tr6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_ompt</span> <span class="ow">and</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ompt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;download-tr6&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uses_opari</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">minimal</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measure_openmp</span> <span class="o">==</span> <span class="s1">&#39;opari&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uses_libotf2</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">minimal</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">==</span> <span class="s1">&#39;otf2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uses_cuda</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">minimal</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cuda_prefix</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cuda_support</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">opencl_support</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;TIME&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># TAU assumes the first metric is always some kind of wallclock timer</span>
            <span class="c1"># so move the first wallclock metric to the front of the list</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;TIME&#39;</span> <span class="ow">in</span> <span class="n">metric</span> <span class="ow">and</span> <span class="s1">&#39;TIME&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;TIME&#39;</span><span class="p">)</span>
        <span class="c1"># Split comma separated metrics</span>
        <span class="n">mets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">met</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
            <span class="n">mets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">met</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">mets</span>
        <span class="n">uses</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pkg</span><span class="p">:</span> <span class="n">sources</span><span class="p">[</span><span class="n">pkg</span><span class="p">]</span> <span class="k">if</span> <span class="n">forced_makefile</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;uses_&#39;</span><span class="o">+</span><span class="n">pkg</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="s1">&#39;binutils&#39;</span><span class="p">,</span> <span class="s1">&#39;libunwind&#39;</span><span class="p">,</span> <span class="s1">&#39;papi&#39;</span><span class="p">,</span> <span class="s1">&#39;pdt&#39;</span><span class="p">,</span> <span class="s1">&#39;ompt&#39;</span><span class="p">,</span> <span class="s1">&#39;libotf2&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">uses</span><span class="p">(</span><span class="n">pkg</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">sources</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uses</span><span class="p">(</span><span class="s1">&#39;scorep&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="s1">&#39;scorep&#39;</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">mpi_support</span><span class="p">,</span> <span class="n">shmem_support</span><span class="p">,</span>
                                <span class="n">uses</span><span class="p">(</span><span class="s1">&#39;binutils&#39;</span><span class="p">),</span> <span class="n">uses</span><span class="p">(</span><span class="s1">&#39;libunwind&#39;</span><span class="p">),</span> <span class="n">uses</span><span class="p">(</span><span class="s1">&#39;papi&#39;</span><span class="p">),</span> <span class="n">uses</span><span class="p">(</span><span class="s1">&#39;pdt&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_env_compat</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="TauInstallation.get_minimal"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.get_minimal">[docs]</a>    <span class="k">def</span> <span class="nf">get_minimal</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a minimal TAU configuration for working with legacy data analysis tools.</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            TauInstallation: Object handle for the TAU installation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tau&#39;</span><span class="p">:</span> <span class="s1">&#39;download&#39;</span><span class="p">}</span>
        <span class="n">target_arch</span> <span class="o">=</span> <span class="n">HOST_ARCH</span>
        <span class="n">target_os</span> <span class="o">=</span> <span class="n">HOST_OS</span>
        <span class="n">target_family</span> <span class="o">=</span> <span class="n">APPLE_LLVM</span> <span class="k">if</span> <span class="n">HOST_OS</span> <span class="ow">is</span> <span class="n">DARWIN</span> <span class="k">else</span> <span class="n">GNU</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">target_compilers</span> <span class="o">=</span> <span class="n">target_family</span><span class="o">.</span><span class="n">installation</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ConfigurationError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> compilers (required to build TAU) could not be found.&quot;</span> <span class="o">%</span> <span class="n">target_family</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">TAU_MINIMAL_COMPILERS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target_compilers</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;A </span><span class="si">%s</span><span class="s2"> compiler (required to build TAU) could not be found.&quot;</span> <span class="o">%</span> <span class="n">role</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
        <span class="n">compilers</span> <span class="o">=</span> <span class="n">InstalledCompilerSet</span><span class="p">(</span><span class="s1">&#39;minimal&#39;</span><span class="p">,</span> <span class="n">Host_CC</span><span class="o">=</span><span class="n">target_compilers</span><span class="p">[</span><span class="n">CC</span><span class="p">],</span> <span class="n">Host_CXX</span><span class="o">=</span><span class="n">target_compilers</span><span class="p">[</span><span class="n">CXX</span><span class="p">])</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">target_arch</span><span class="p">,</span> <span class="n">target_os</span><span class="p">,</span> <span class="n">compilers</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inst</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="TauInstallation.check_env_compat"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.check_env_compat">[docs]</a>    <span class="k">def</span> <span class="nf">check_env_compat</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks the current shell environment for incompatible libraries or modules.</span>
<span class="sd">    </span>
<span class="sd">        Other instrumentation packages like Darshan can conflict with TAU.  This routine</span>
<span class="sd">        checks that no conflicting packages are active in the current environment.</span>
<span class="sd">    </span>
<span class="sd">        Raises:</span>
<span class="sd">            ConfigurationError: TAU cannot be used in the current environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;DARSHAN_PRELOAD&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">or</span> <span class="s1">&#39;darshan&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LOADEDMODULES&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;TAU cannot be used with darshan. &quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;Unload the darshan module and try again.&quot;</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PE_ENV&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;cray&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;TAU Commander cannot be used with Cray compilers. &quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;Replace PrgEnv-cray with PrgEnv-intel, PrgEnv-gnu, or PrgEnv-pgi and try again.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TauInstallation.uid_items"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.uid_items">[docs]</a>    <span class="k">def</span> <span class="nf">uid_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">uid_parts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_os</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="c1"># TAU changes if any compiler changes.</span>
        <span class="n">uid_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">uid</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()))</span>
        <span class="c1"># TAU changes if any dependencies change.</span>
        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="s1">&#39;binutils&#39;</span><span class="p">,</span> <span class="s1">&#39;libunwind&#39;</span><span class="p">,</span> <span class="s1">&#39;papi&#39;</span><span class="p">,</span> <span class="s1">&#39;pdt&#39;</span><span class="p">,</span> <span class="s1">&#39;ompt&#39;</span><span class="p">,</span> <span class="s1">&#39;libotf2&#39;</span><span class="p">,</span> <span class="s1">&#39;scorep&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;uses_&#39;</span><span class="o">+</span><span class="n">pkg</span><span class="p">):</span>
                <span class="n">uid_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">pkg</span><span class="p">]</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
        <span class="c1"># TAU changes if any of its hard-coded limits change</span>
        <span class="n">uid_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_max_threads</span><span class="p">()),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_max_metrics</span><span class="p">())])</span>
        <span class="k">return</span> <span class="n">uid_parts</span></div>

    <span class="k">def</span> <span class="nf">_get_max_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pthreads_support</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">openmp_support</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbb_support</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpc_support</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span> <span class="ow">in</span> <span class="p">(</span><span class="n">INTEL_KNC</span><span class="p">,</span> <span class="n">INTEL_KNL</span><span class="p">):</span>
                    <span class="n">nprocs</span> <span class="o">=</span> <span class="mi">72</span> <span class="c1"># Assume minimum 1 rank per quadrant w/ 4HTs</span>
                    <span class="k">return</span> <span class="n">nprocs</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nprocs</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
                    <span class="c1"># Assume 2 HTs/core</span>
                    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">nprocs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">25</span> <span class="c1"># This is currently TAU&#39;s default.</span>

    <span class="k">def</span> <span class="nf">_get_max_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_install_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Use `self.uid` as a TAU tag and the source package top-level directory as the installation tag</span>
        <span class="c1"># so multiple TAU installations share the large common files.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_install_tag</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">source_archive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquire_source</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_install_tag</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">archive_toplevel</span><span class="p">(</span><span class="n">source_archive</span><span class="p">)</span>
            <span class="c1"># If tau nightly, add current date to tag</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">==</span> <span class="n">NIGHTLY</span><span class="p">:</span>
                <span class="n">nightlies</span><span class="o">=</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">source_archive</span><span class="p">),</span> <span class="s1">&#39;tau-nightly-*.tgz&#39;</span><span class="p">))</span>
                <span class="n">nightlies_downloaded</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">nightlies</span> <span class="k">else</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_nightly</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">nightlies_downloaded</span><span class="p">:</span>
                    <span class="n">current_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;-%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_install_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_install_tag</span> <span class="o">+</span> <span class="n">current_date</span>
                    <span class="c1"># Move to new tgz file</span>
                    <span class="n">new_archive_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">source_archive</span><span class="p">),</span> <span class="s1">&#39;tau-nightly&#39;</span> <span class="o">+</span> <span class="n">current_date</span> <span class="o">+</span> <span class="s1">&#39;.tgz&#39;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">source_archive</span><span class="p">,</span> <span class="n">new_archive_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">new_archive_name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">last_nightly</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nightlies</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">nightly_date</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">last_nightly</span><span class="p">)[</span><span class="mi">11</span><span class="p">:</span><span class="mi">22</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_install_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_install_tag</span> <span class="o">+</span> <span class="n">nightly_date</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">last_nightly</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_install_tag</span>
    
    <span class="k">def</span> <span class="nf">_verify_tau_libs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau_makefile</span><span class="p">):</span>
        <span class="n">makefile_tags</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tau_makefile</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Makefile.tau&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">static_lib</span> <span class="o">=</span> <span class="s2">&quot;libtau</span><span class="si">%s</span><span class="s2">.*&quot;</span> <span class="o">%</span> <span class="n">makefile_tags</span>
        <span class="n">shared_lib</span> <span class="o">=</span> <span class="s2">&quot;libTAUsh</span><span class="si">%s</span><span class="s2">.*&quot;</span> <span class="o">%</span> <span class="n">makefile_tags</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">static_lib</span><span class="p">,</span> <span class="n">shared_lib</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lib_path</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;TAU libraries for makefile &#39;</span><span class="si">%s</span><span class="s2">&#39; not found&quot;</span> <span class="o">%</span> <span class="n">tau_makefile</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_verify_dependency_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau_makefile</span><span class="p">):</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking dependency paths in &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">tau_makefile</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tau_makefile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="s1">&#39;BFDINCLUDE=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_binutils</span><span class="p">:</span>
                        <span class="n">binutils</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="s1">&#39;binutils&#39;</span><span class="p">]</span>
                        <span class="n">bfd_inc</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;-I&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">bfd_inc</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;BFDINCLUDE in &#39;</span><span class="si">%s</span><span class="s2">&#39; is not a directory&quot;</span> <span class="o">%</span> <span class="n">tau_makefile</span><span class="p">)</span>                            
                        <span class="k">if</span> <span class="n">binutils</span><span class="o">.</span><span class="n">include_path</span> <span class="o">!=</span> <span class="n">bfd_inc</span><span class="p">:</span>
                            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;BFDINCLUDE=&#39;</span><span class="si">%s</span><span class="s2">&#39; != &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">bfd_inc</span><span class="p">,</span> <span class="n">binutils</span><span class="o">.</span><span class="n">include_path</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;BFDINCLUDE in &#39;</span><span class="si">%s</span><span class="s2">&#39; is not &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> 
                                                       <span class="p">(</span><span class="n">tau_makefile</span><span class="p">,</span> <span class="n">binutils</span><span class="o">.</span><span class="n">include_path</span><span class="p">))</span>
                <span class="k">elif</span> <span class="s1">&#39;UNWIND_INC=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_libunwind</span><span class="p">:</span> 
                        <span class="n">libunwind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="s1">&#39;libunwind&#39;</span><span class="p">]</span>
                        <span class="n">libunwind_inc</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;-I&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">libunwind_inc</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;UNWIND_INC in &#39;</span><span class="si">%s</span><span class="s2">&#39; is not a directory&quot;</span> <span class="o">%</span> <span class="n">tau_makefile</span><span class="p">)</span>                            
                        <span class="k">if</span> <span class="n">libunwind</span><span class="o">.</span><span class="n">include_path</span> <span class="o">!=</span> <span class="n">libunwind_inc</span><span class="p">:</span>
                            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;UNWIND_INC=&#39;</span><span class="si">%s</span><span class="s2">&#39; != &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">libunwind_inc</span><span class="p">,</span> <span class="n">libunwind</span><span class="o">.</span><span class="n">include_path</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;UNWIND_INC in &#39;</span><span class="si">%s</span><span class="s2">&#39; is not &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> 
                                                       <span class="p">(</span><span class="n">tau_makefile</span><span class="p">,</span> <span class="n">libunwind</span><span class="o">.</span><span class="n">include_path</span><span class="p">))</span>
                <span class="k">elif</span> <span class="s1">&#39;PAPIDIR=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_papi</span><span class="p">:</span>
                        <span class="n">papi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="s1">&#39;papi&#39;</span><span class="p">]</span>
                        <span class="n">papi_dir</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">papi_dir</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;PAPI_DIR in &#39;</span><span class="si">%s</span><span class="s2">&#39; is not a directory&quot;</span> <span class="o">%</span> <span class="n">tau_makefile</span><span class="p">)</span>                            
                        <span class="k">if</span> <span class="n">papi</span><span class="o">.</span><span class="n">install_prefix</span> <span class="o">!=</span> <span class="n">papi_dir</span><span class="p">:</span>
                            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PAPI_DIR=&#39;</span><span class="si">%s</span><span class="s2">&#39; != &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">papi_dir</span><span class="p">,</span> <span class="n">papi</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;PAPI_DIR in &#39;</span><span class="si">%s</span><span class="s2">&#39; is not &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> 
                                                       <span class="p">(</span><span class="n">tau_makefile</span><span class="p">,</span> <span class="n">papi</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">))</span>
                <span class="k">elif</span> <span class="s1">&#39;SCOREPDIR=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_scorep</span><span class="p">:</span>
                        <span class="n">scorep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="s1">&#39;scorep&#39;</span><span class="p">]</span>
                        <span class="n">scorep_dir</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">scorep_dir</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;SCOREPDIR in &#39;</span><span class="si">%s</span><span class="s2">&#39; is not a directory&quot;</span> <span class="o">%</span> <span class="n">tau_makefile</span><span class="p">)</span>                            
                        <span class="k">if</span> <span class="n">scorep</span><span class="o">.</span><span class="n">install_prefix</span> <span class="o">!=</span> <span class="n">scorep_dir</span><span class="p">:</span>
                            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SCOREPDIR=&#39;</span><span class="si">%s</span><span class="s2">&#39; != &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">scorep_dir</span><span class="p">,</span> <span class="n">scorep</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;SCOREPDIR in &#39;</span><span class="si">%s</span><span class="s2">&#39; is not &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> 
                                                       <span class="p">(</span><span class="n">tau_makefile</span><span class="p">,</span> <span class="n">scorep</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">))</span>
                <span class="k">elif</span> <span class="s1">&#39;OTFINC=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_libotf2</span><span class="p">:</span>
                        <span class="n">libotf2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="s1">&#39;libotf2&#39;</span><span class="p">]</span>
                        <span class="n">libotf2_dir</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;-I&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">libotf2_dir</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;OTFINC in &#39;</span><span class="si">%s</span><span class="s2">&#39; is not a directory&quot;</span> <span class="o">%</span> <span class="n">tau_makefile</span><span class="p">)</span>                            
                        <span class="k">if</span> <span class="n">libotf2</span><span class="o">.</span><span class="n">include_path</span> <span class="o">!=</span> <span class="n">libotf2_dir</span><span class="p">:</span>
                            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;OTFINC=&#39;</span><span class="si">%s</span><span class="s2">&#39; != &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">libotf2_dir</span><span class="p">,</span> <span class="n">libotf2</span><span class="o">.</span><span class="n">include_path</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;OTFINC in &#39;</span><span class="si">%s</span><span class="s2">&#39; is not &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> 
                                                       <span class="p">(</span><span class="n">tau_makefile</span><span class="p">,</span> <span class="n">libotf2</span><span class="o">.</span><span class="n">include_path</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_verify_iowrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau_makefile</span><span class="p">):</span>
        <span class="c1"># Replace right-most occurance of &#39;Makefile.tau&#39; with &#39;shared&#39;</span>
        <span class="n">tagged_shared_dir</span> <span class="o">=</span> <span class="s1">&#39;shared&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tau_makefile</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;Makefile.tau&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">shared_dir</span> <span class="ow">in</span> <span class="n">tagged_shared_dir</span><span class="p">,</span> <span class="s1">&#39;shared&#39;</span><span class="p">:</span>
            <span class="n">iowrap_libs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shared_dir</span><span class="p">,</span> <span class="s1">&#39;libTAU-iowrap*&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">iowrap_libs</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;TAU I/O wrapper libraries not found in &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">shared_dir</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found iowrap shared libraries: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">iowrap_libs</span><span class="p">)</span>
        <span class="n">io_wrapper_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lib_path</span><span class="p">,</span> <span class="s1">&#39;wrappers&#39;</span><span class="p">,</span> <span class="s1">&#39;io_wrapper&#39;</span><span class="p">)</span>
        <span class="n">iowrap_link_options</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">io_wrapper_dir</span><span class="p">,</span> <span class="s1">&#39;link_options.tau&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">iowrap_link_options</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;TAU I/O wrapper link options not found in &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">io_wrapper_dir</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found iowrap link options: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">iowrap_link_options</span><span class="p">)</span>
    
<div class="viewcode-block" id="TauInstallation.verify"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.verify">[docs]</a>    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TauInstallation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">verify</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimal</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_papi</span> <span class="ow">and</span> <span class="p">(</span><span class="n">HOST_ARCH</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span> <span class="ow">and</span> <span class="n">HOST_OS</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_os</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="s1">&#39;papi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">check_metrics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">ConfigurationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="n">tau_makefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_makefile</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_tau_libs</span><span class="p">(</span><span class="n">tau_makefile</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">unmanaged</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_verify_dependency_paths</span><span class="p">(</span><span class="n">tau_makefile</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_io</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_verify_iowrapper</span><span class="p">(</span><span class="n">tau_makefile</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TAU installation at &#39;</span><span class="si">%s</span><span class="s2">&#39; is valid&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_select_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">libglobs</span><span class="p">,</span> <span class="n">user_libraries</span><span class="p">,</span> <span class="n">wrap_cc</span><span class="p">,</span> <span class="n">wrap_cxx</span><span class="p">,</span> <span class="n">wrap_fc</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">unique</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seq</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">or</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
        <span class="n">selected_inc</span><span class="p">,</span> <span class="n">selected_lib</span><span class="p">,</span> <span class="n">selected_library</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
        <span class="n">include_path</span> <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">wrap_cc</span><span class="o">.</span><span class="n">include_path</span> <span class="o">+</span> <span class="n">wrap_cxx</span><span class="o">.</span><span class="n">include_path</span> <span class="o">+</span> <span class="n">wrap_fc</span><span class="o">.</span><span class="n">include_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_path</span><span class="p">:</span>
            <span class="c1"># Unfortunately, TAU&#39;s configure script can only accept one path on -mpiinc</span>
            <span class="c1"># and it expects the compiler&#39;s include path argument (e.g. &quot;-I&quot;) to be omitted</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">include_path</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">header</span><span class="p">)):</span>
                    <span class="n">selected_inc</span> <span class="o">=</span> <span class="n">path</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_magic</span><span class="o">.</span><span class="n">operating_system</span> <span class="ow">is</span> <span class="n">CRAY_CNL</span><span class="p">:</span>
                    <span class="n">hints</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Check that the &#39;cray-shmem&#39; module is loaded&quot;</span><span class="p">,)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hints</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found on include path: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                         <span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">include_path</span><span class="p">)),</span>
                                         <span class="o">*</span><span class="n">hints</span><span class="p">)</span>
        <span class="n">library_path</span> <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">wrap_cc</span><span class="o">.</span><span class="n">library_path</span> <span class="o">+</span> <span class="n">wrap_cxx</span><span class="o">.</span><span class="n">library_path</span> <span class="o">+</span> <span class="n">wrap_fc</span><span class="o">.</span><span class="n">library_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">library_path</span><span class="p">:</span>
            <span class="n">selected_lib</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">libglob</span> <span class="ow">in</span> <span class="n">libglobs</span><span class="p">:</span>
                <span class="c1"># Unfortunately, TAU&#39;s configure script can only accept one path on -mpilib</span>
                <span class="c1"># and it expects the compiler&#39;s include path argument (e.g. &quot;-L&quot;) to be omitted</span>
                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">library_path</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">libglob</span><span class="p">)):</span>
                        <span class="n">selected_lib</span> <span class="o">=</span> <span class="n">path</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_lib</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;No files matched &#39;</span><span class="si">%s</span><span class="s2">&#39; on library path: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                         <span class="p">(</span><span class="n">libglobs</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">library_path</span><span class="p">)))</span>
        <span class="c1"># Don&#39;t add autodetected Fortran or C++ libraries; C is probably OK</span>
        <span class="n">libraries</span> <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">user_libraries</span> <span class="o">+</span> <span class="n">wrap_cc</span><span class="o">.</span><span class="n">libraries</span> <span class="o">+</span> <span class="n">wrap_cxx</span><span class="o">.</span><span class="n">libraries</span> <span class="o">+</span> <span class="n">wrap_fc</span><span class="o">.</span><span class="n">libraries</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">libraries</span><span class="p">:</span>
            <span class="c1"># TAU&#39;s configure script accepts multiple libraries but only if they&#39;re separated by a &#39;#&#39; symbol</span>
            <span class="c1"># and the compiler&#39;s library linking flag (e.g. &#39;-l&#39;) must be included</span>
            <span class="n">link_library_flag</span> <span class="o">=</span> <span class="n">wrap_cc</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">link_library_flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">link_library_flag</span><span class="o">+</span><span class="n">lib</span> <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">libraries</span><span class="p">]</span>
            <span class="c1"># Also jam missing library path&#39;s onto this option</span>
            <span class="n">library_path_flag</span> <span class="o">=</span> <span class="n">wrap_cc</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">library_path_flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">library_path_flag</span><span class="o">+</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">library_path</span> <span class="k">if</span> <span class="n">path</span> <span class="o">!=</span> <span class="n">selected_lib</span><span class="p">]</span> <span class="o">+</span> <span class="n">parts</span>
            <span class="n">selected_library</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">selected_inc</span><span class="p">,</span> <span class="n">selected_lib</span><span class="p">,</span> <span class="n">selected_library</span>

<div class="viewcode-block" id="TauInstallation.configure"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configures TAU</span>

<span class="sd">        Executes TAU&#39;s configuration script with appropriate arguments to support the specified configuration.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SoftwareConfigurationError: TAU&#39;s configure script failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">binutils</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;binutils&#39;</span><span class="p">)</span>
        <span class="n">libunwind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;libunwind&#39;</span><span class="p">)</span>
        <span class="n">papi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;papi&#39;</span><span class="p">)</span>
        <span class="n">pdt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pdt&#39;</span><span class="p">)</span>
        <span class="n">scorep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scorep&#39;</span><span class="p">)</span>
        <span class="n">ompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ompt&#39;</span><span class="p">)</span>
        <span class="n">libotf2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;libotf2&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimal</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuring minimal TAU...&quot;</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> 
                   <span class="p">[</span><span class="s1">&#39;./configure&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;-tag=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
                    <span class="s1">&#39;-arch=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_magic</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s1">&#39;-bfd=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">binutils</span><span class="o">.</span><span class="n">install_prefix</span> <span class="k">if</span> <span class="n">binutils</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="s1">&#39;-unwind=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">libunwind</span><span class="o">.</span><span class="n">install_prefix</span> <span class="k">if</span> <span class="n">libunwind</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                   <span class="p">]</span> <span class="k">if</span> <span class="n">flag</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">create_subprocess</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_prefix</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s1">&#39;TAU configure failed&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># TAU&#39;s configure script can&#39;t cope with compiler absolute paths or compiler names that</span>
        <span class="c1"># don&#39;t exactly match what it expects.  Use `info.command` instead of `command` to work</span>
        <span class="c1"># around these problems e.g. &#39;gcc-4.9&#39; becomes &#39;gcc&#39;.</span>
        <span class="c1"># Also, TAU&#39;s configure script does a really bad job detecting wrapped compiler commands</span>
        <span class="c1"># so we unwrap the wrapper here before invoking configure.</span>
        <span class="n">cc_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">[</span><span class="n">CC</span><span class="p">]</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">command</span>
        <span class="n">cxx_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">[</span><span class="n">CXX</span><span class="p">]</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">command</span>
        <span class="n">fc_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">[</span><span class="n">FC</span><span class="p">]</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span> <span class="k">if</span> <span class="n">FC</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span> <span class="k">else</span> <span class="bp">None</span>

        <span class="c1"># TAU&#39;s configure script can&#39;t detect Fortran compiler from the compiler</span>
        <span class="c1"># command so translate Fortran compiler command into TAU&#39;s magic words</span>
        <span class="n">fortran_magic</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">fc_comp</span><span class="p">:</span>
            <span class="n">fc_family</span> <span class="o">=</span> <span class="n">fc_comp</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">family</span>
            <span class="n">fc_magic_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">host_compilers</span><span class="o">.</span><span class="n">GNU</span><span class="p">:</span> <span class="s1">&#39;gfortran&#39;</span><span class="p">,</span>
                            <span class="n">host_compilers</span><span class="o">.</span><span class="n">INTEL</span><span class="p">:</span> <span class="s1">&#39;intel&#39;</span><span class="p">,</span>
                            <span class="n">host_compilers</span><span class="o">.</span><span class="n">PGI</span><span class="p">:</span> <span class="s1">&#39;pgi&#39;</span><span class="p">,</span>
                            <span class="n">host_compilers</span><span class="o">.</span><span class="n">CRAY</span><span class="p">:</span> <span class="s1">&#39;cray&#39;</span><span class="p">,</span>
                            <span class="n">host_compilers</span><span class="o">.</span><span class="n">IBM</span><span class="p">:</span> <span class="s1">&#39;ibm&#39;</span><span class="p">,</span>
                            <span class="n">host_compilers</span><span class="o">.</span><span class="n">IBM_BG</span><span class="p">:</span> <span class="s1">&#39;ibm&#39;</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fortran_magic</span> <span class="o">=</span> <span class="n">fc_magic_map</span><span class="p">[</span><span class="n">fc_family</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">caf_support</span><span class="p">:</span>
                    <span class="n">fortran_magic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">[</span><span class="n">CAF_FC</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">command</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t determine TAU magic word for </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fc_comp</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">short_descr</span><span class="p">,</span> <span class="n">fc_comp</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InternalError</span><span class="p">(</span><span class="s2">&quot;Unknown compiler family for Fortran: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">fc_family</span><span class="p">)</span>

        <span class="c1"># Set up MPI paths and libraries</span>
        <span class="n">mpiinc</span><span class="p">,</span> <span class="n">mpilib</span><span class="p">,</span> <span class="n">mpilibrary</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_support</span><span class="p">:</span>
            <span class="n">mpiinc</span><span class="p">,</span> <span class="n">mpilib</span><span class="p">,</span> <span class="n">mpilibrary</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_select_flags</span><span class="p">(</span><span class="s1">&#39;mpi.h&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;libmpi*&#39;</span><span class="p">,),</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">mpi_libraries</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">[</span><span class="n">MPI_CC</span><span class="p">],</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">[</span><span class="n">MPI_CXX</span><span class="p">],</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">[</span><span class="n">MPI_FC</span><span class="p">])</span>

        <span class="c1"># Set up SHMEM paths and libraries</span>
        <span class="n">shmeminc</span><span class="p">,</span> <span class="n">shmemlib</span><span class="p">,</span> <span class="n">shmemlibrary</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shmem_support</span><span class="p">:</span>
            <span class="n">shmeminc</span><span class="p">,</span> <span class="n">shmemlib</span><span class="p">,</span> <span class="n">shmemlibrary</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_select_flags</span><span class="p">(</span><span class="s1">&#39;shmem.h&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lib*shmem*&#39;</span><span class="p">,</span> <span class="s1">&#39;lib*sma*&#39;</span><span class="p">),</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">shmem_libraries</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">[</span><span class="n">SHMEM_CC</span><span class="p">],</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">[</span><span class="n">SHMEM_CXX</span><span class="p">],</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">[</span><span class="n">SHMEM_FC</span><span class="p">])</span>

        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span>
                 <span class="p">[</span><span class="s1">&#39;-tag=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
                  <span class="s1">&#39;-arch=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_magic</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                  <span class="s1">&#39;-cc=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cc_command</span><span class="p">,</span>
                  <span class="s1">&#39;-c++=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cxx_command</span><span class="p">,</span>
                  <span class="s1">&#39;-fortran=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fortran_magic</span> <span class="k">if</span> <span class="n">fortran_magic</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-bfd=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">binutils</span><span class="o">.</span><span class="n">install_prefix</span> <span class="k">if</span> <span class="n">binutils</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-papi=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">papi</span><span class="o">.</span><span class="n">install_prefix</span> <span class="k">if</span> <span class="n">papi</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-unwind=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">libunwind</span><span class="o">.</span><span class="n">install_prefix</span> <span class="k">if</span> <span class="n">libunwind</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-scorep=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">scorep</span><span class="o">.</span><span class="n">install_prefix</span> <span class="k">if</span> <span class="n">scorep</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-tbb&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbb_support</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-mpi&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_support</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-mpiinc=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mpiinc</span> <span class="k">if</span> <span class="n">mpiinc</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-mpilib=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mpilib</span> <span class="k">if</span> <span class="n">mpilib</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-mpilibrary=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mpilibrary</span> <span class="k">if</span> <span class="n">mpilibrary</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-cuda=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda_prefix</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_cuda</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-opencl=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">opencl_prefix</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opencl_prefix</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-shmem&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shmem_support</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-shmeminc=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">shmeminc</span> <span class="k">if</span> <span class="n">shmeminc</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-shmemlib=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">shmemlib</span> <span class="k">if</span> <span class="n">shmemlib</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-shmemlibrary=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">shmemlibrary</span> <span class="k">if</span> <span class="n">shmemlibrary</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                  <span class="s1">&#39;-otf=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">libotf2</span><span class="o">.</span><span class="n">install_prefix</span> <span class="k">if</span> <span class="n">libotf2</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="p">]</span> <span class="k">if</span> <span class="n">flag</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pdt</span><span class="p">:</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-pdt=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pdt</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">)</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-pdt_c++=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pdt</span><span class="o">.</span><span class="n">compilers</span><span class="p">[</span><span class="n">CXX</span><span class="p">]</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pthreads_support</span><span class="p">:</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-pthread&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">openmp_support</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_openmp</span> <span class="o">==</span> <span class="s1">&#39;ignore&#39;</span><span class="p">:</span>
                <span class="c1"># Configure with -pthread to support multi-threading without instrumenting OpenMP directives</span>
                <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-pthread&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-openmp&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_openmp</span> <span class="o">==</span> <span class="s1">&#39;ompt&#39;</span><span class="p">:</span>
                    <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-ompt=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ompt</span><span class="o">.</span><span class="n">install_prefix</span> <span class="k">if</span> <span class="n">ompt</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_openmp</span> <span class="o">==</span> <span class="s1">&#39;opari&#39;</span><span class="p">:</span>
                    <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-opari&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InternalError</span><span class="p">(</span><span class="s2">&quot;Invalid value for measure_openmp: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_openmp</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_io</span><span class="p">:</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-iowrapper&#39;</span><span class="p">)</span>

        <span class="c1"># Use -useropt for hacks and workarounds.</span>
        <span class="n">useropts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-O2&#39;</span><span class="p">,</span> <span class="s1">&#39;-g&#39;</span><span class="p">]</span>
        <span class="c1"># Work around TAU&#39;s silly hard-coded limits.</span>
        <span class="n">useropts</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-DTAU_MAX_THREADS=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_max_threads</span><span class="p">(),</span>
                         <span class="s1">&#39;-DTAU_MAX_METRICS=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_max_metrics</span><span class="p">(),</span>
                         <span class="s1">&#39;-DTAU_MAX_COUNTERS=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_max_metrics</span><span class="p">()])</span>
        <span class="c1"># -useropt flag uses &#39;#&#39; as an argument separator</span>
        <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-useropt=&#39;</span> <span class="o">+</span> <span class="s1">&#39;#&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">useropts</span><span class="p">))</span>
        
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;./configure&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">flags</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuring TAU...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">create_subprocess</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_prefix</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s1">&#39;TAU configure failed&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TauInstallation.make_install_minimal"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.make_install_minimal">[docs]</a>    <span class="k">def</span> <span class="nf">make_install_minimal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;make&#39;</span><span class="p">,</span> <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="s1">&#39;install&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">parallel_make_flags</span><span class="p">()</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Compiling TAU utilities...&#39;</span><span class="p">)</span>
        <span class="c1"># Nonzero return value is ignored since a full make would be required for all utilities to build.</span>
        <span class="c1"># Just cross your fingers and hope that the utilities you need are compiled.</span>
        <span class="c1"># If they don&#39;t build then package verification will fail so no harm done.  </span>
        <span class="n">util</span><span class="o">.</span><span class="n">create_subprocess</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_prefix</span><span class="p">,</span> <span class="s1">&#39;utils&#39;</span><span class="p">),</span> <span class="n">stdout</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TauInstallation.make_install"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.make_install">[docs]</a>    <span class="k">def</span> <span class="nf">make_install</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Installs TAU to ``self.install_prefix``.</span>

<span class="sd">        Executes &#39;make install&#39; to build and install TAU.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SoftwarePackageError: &#39;make install&#39; failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;make&#39;</span><span class="p">,</span> <span class="s1">&#39;install&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">parallel_make_flags</span><span class="p">()</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Compiling TAU...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">create_subprocess</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_prefix</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s1">&#39;TAU compilation/installation failed&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TauInstallation.install"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.install">[docs]</a>    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reinstall</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Installs TAU.</span>

<span class="sd">        Configures, compiles, and installs TAU with all necessarry makefiles and libraries.</span>

<span class="sd">        Args:</span>
<span class="sd">            force_reinstall (bool): Set to True to force reinstall even if TAU is already installed and working.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SoftwarePackageError: TAU failed installation or did not pass verification after it was installed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_env_compat</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forced_makefile</span><span class="p">:</span>
            <span class="n">forced_install_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forced_makefile</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_install_prefix</span><span class="p">(</span><span class="n">forced_install_prefix</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;TAU makefile was forced! Not verifying TAU installation&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">unmanaged_hints</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Allow TAU Commander to manage your TAU configurations&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Check for earlier error or warning messages&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Ask your system administrator to build any missing TAU configurations mentioned above&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unmanaged</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">force_reinstall</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">SoftwarePackageError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unmanaged</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> source package is unavailable and the installation at &#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>
                                               <span class="s2">&quot;is invalid:</span><span class="se">\n\n</span><span class="s2">    </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">,</span> <span class="n">err</span><span class="p">),</span>
                                               <span class="o">*</span><span class="n">unmanaged_hints</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">force_reinstall</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;TAU must be reconfigured: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unmanaged</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">path_accessible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;Unable to configure TAU: &#39;</span><span class="si">%s</span><span class="s2">&#39; is not writable.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">,</span>
                                       <span class="o">*</span><span class="n">unmanaged_hints</span><span class="p">)</span>
        <span class="c1"># Check dependencies after verifying TAU instead of before in case </span>
        <span class="c1"># we&#39;re using an unmanaged TAU or forced makefile. </span>
        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">pkg</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">force_reinstall</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Installing </span><span class="si">%s</span><span class="s2"> at &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">new_os_environ</span><span class="p">(),</span> <span class="n">util</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mo">002</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Keep reconfiguring the same source because that&#39;s how TAU works</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">include_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">include_path</span><span class="p">)):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prepare_src</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_src_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_prefix</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">installation_sequence</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_group</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">SoftwarePackageError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">path_accessible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">):</span>
                    <span class="n">err</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="s2">&quot;: the TAU installation at &#39;</span><span class="si">%s</span><span class="s2">&#39; is not writable&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_prefix</span>
                    <span class="n">err</span><span class="o">.</span><span class="n">hints</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Grant write permission on &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">]</span> <span class="o">+</span> <span class="n">unmanaged_hints</span> <span class="o">+</span> <span class="n">err</span><span class="o">.</span><span class="n">hints</span>
                    <span class="n">parent_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">path_accessible</span><span class="p">(</span><span class="n">parent_prefix</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">):</span>
                        <span class="n">err</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="s2">&quot; (but the parent directory is)&quot;</span>
                <span class="k">raise</span> <span class="n">err</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> installation failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="c1"># Verify the new installation</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Verifying </span><span class="si">%s</span><span class="s2"> installation...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="TauInstallation.installation_sequence"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.installation_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">installation_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_install_minimal</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_install</span><span class="p">()</span>
        <span class="c1"># Rebuild makefile cache on next call to get_makefile() </span>
        <span class="c1"># since a new, possibly better makefile is now available</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tau_makefile</span> <span class="o">=</span> <span class="bp">None</span></div>

    <span class="k">def</span> <span class="nf">_compiler_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">host_compilers</span><span class="o">.</span><span class="n">INTEL</span><span class="p">:</span> <span class="s1">&#39;intel&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_magic</span><span class="o">.</span><span class="n">operating_system</span> <span class="ow">is</span> <span class="n">CRAY_CNL</span> <span class="k">else</span> <span class="s1">&#39;icpc&#39;</span><span class="p">,</span>
                <span class="n">host_compilers</span><span class="o">.</span><span class="n">PGI</span><span class="p">:</span> <span class="s1">&#39;pgi&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="TauInstallation.get_tags"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.get_tags">[docs]</a>    <span class="k">def</span> <span class="nf">get_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get tags for this TAU installation.</span>

<span class="sd">        Each TAU configuration (makefile, library, Python bindings, etc.) is identified by its tags.</span>
<span class="sd">        Tags can appear in the makefile name in any order so the order of the tags returned by this</span>
<span class="sd">        function will likely not match the order they appear in the makefile name or tau_exec command line.</span>

<span class="sd">        Returns:</span>
<span class="sd">            set: Makefile tags, e.g. set(&#39;papi&#39;, &#39;pdt&#39;, &#39;icpc&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
        <span class="n">cxx_compiler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">[</span><span class="n">CXX</span><span class="p">]</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compiler_tags</span><span class="p">()[</span><span class="n">cxx_compiler</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">family</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_pdt</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;pdt&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_papi</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;papi&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_scorep</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;scorep&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pthreads_support</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;pthread&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">openmp_support</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_openmp</span> <span class="o">==</span> <span class="s1">&#39;ignore&#39;</span><span class="p">:</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;pthread&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;openmp&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_openmp</span> <span class="o">==</span> <span class="s1">&#39;ompt&#39;</span><span class="p">:</span>
                    <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ompt&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_openmp</span> <span class="o">==</span> <span class="s1">&#39;opari&#39;</span><span class="p">:</span>
                    <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;opari&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InternalError</span><span class="p">(</span><span class="s2">&quot;Invalid value for measure_openmp: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_openmp</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tbb_support</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tbb&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_support</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;mpi&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda_support</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">opencl_support</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;cupti&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shmem_support</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;shmem&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpc_support</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;mpc&#39;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TAU tags: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tags</span></div>

<div class="viewcode-block" id="TauInstallation._incompatible_tags"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation._incompatible_tags">[docs]</a>    <span class="k">def</span> <span class="nf">_incompatible_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a set of makefile tags incompatible with the specified config.&quot;&quot;&quot;</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">cxx_compiler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">[</span><span class="n">CXX</span><span class="p">]</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span>
        <span class="c1"># On Cray, TAU ignores compiler command line arguments and tags makefiles </span>
        <span class="c1"># according to what is specified in $PE_ENV, so the minimal configuration</span>
        <span class="c1"># could have any compiler tag and still be compatible.</span>
        <span class="c1"># On non-Cray systems, exclude tags from incompatible compilers.</span>
        <span class="n">compiler_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiler_tags</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_magic</span><span class="o">.</span><span class="n">operating_system</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">CRAY_CNL</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">compiler_tag</span> <span class="o">=</span> <span class="n">compiler_tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cxx_compiler</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">tags</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tag</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">compiler_tags</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span> <span class="k">if</span> <span class="n">tag</span> <span class="o">!=</span> <span class="n">compiler_tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_support</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;mpi&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_openmp</span> <span class="o">==</span> <span class="s1">&#39;ignore&#39;</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;openmp&#39;</span><span class="p">)</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;opari&#39;</span><span class="p">)</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ompt&#39;</span><span class="p">)</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;gomp&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_scorep</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;scorep&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shmem_support</span><span class="p">:</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;shmem&#39;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Incompatible tags: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tags</span></div>
    
    <span class="k">def</span> <span class="nf">_makefile_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">makefile</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">makefile</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="k">def</span> <span class="nf">_match_makefile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_tags</span><span class="p">):</span>
        <span class="n">tau_makefiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lib_path</span><span class="p">,</span> <span class="s1">&#39;Makefile.tau*&#39;</span><span class="p">))</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found makefiles: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">tau_makefiles</span><span class="p">)</span>
        <span class="n">dangerous_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incompatible_tags</span><span class="p">()</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Will not use makefiles containing tags: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dangerous_tags</span><span class="p">)</span>
        <span class="n">approx_tags</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">approx_makefile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">makefile</span> <span class="ow">in</span> <span class="n">tau_makefiles</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makefile_tags</span><span class="p">(</span><span class="n">makefile</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has tags: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">makefile</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config_tags</span> <span class="o">&lt;=</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> contains desired tags: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">makefile</span><span class="p">,</span> <span class="n">config_tags</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tags</span> <span class="o">&lt;=</span> <span class="n">config_tags</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found TAU makefile </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">makefile</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">makefile</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">tags</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">dangerous_tags</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">approx_tags</span> <span class="ow">or</span> <span class="n">tags</span> <span class="o">&lt;</span> <span class="n">approx_tags</span><span class="p">:</span>
                        <span class="n">approx_makefile</span> <span class="o">=</span> <span class="n">makefile</span>
                        <span class="n">approx_tags</span> <span class="o">=</span> <span class="n">tags</span>
        <span class="k">return</span> <span class="n">approx_makefile</span>
    
<div class="viewcode-block" id="TauInstallation.get_makefile"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.get_makefile">[docs]</a>    <span class="k">def</span> <span class="nf">get_makefile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an absolute path to a TAU_MAKEFILE.</span>

<span class="sd">        The file returned *should* supply all requested measurement features</span>
<span class="sd">        and application support features specified in the constructor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A file path that could be used to set the TAU_MAKEFILE environment</span>
<span class="sd">                 variable, or None if a suitable makefile couldn&#39;t be found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tau_makefile</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tau_makefile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forced_makefile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tau_makefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forced_makefile</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forced_makefile</span>
        <span class="n">config_tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching for makefile with tags: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config_tags</span><span class="p">)</span>
        <span class="n">makefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_makefile</span><span class="p">(</span><span class="n">config_tags</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">makefile</span><span class="p">:</span> 
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No TAU makefile exactly matches tags &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">config_tags</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">unmanaged</span><span class="p">:</span>
                <span class="c1"># This is a managed TAU installation so we can build it.</span>
                <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;TAU Makefile not found for tags &#39;</span><span class="si">%s</span><span class="s2">&#39; in &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_tags</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">))</span>
            <span class="c1"># Ignore UID and try again in case the TAU configuration was built manually without a UID.</span>
            <span class="c1"># Warn the user that it&#39;s on them to know that the makefile is correct.</span>
            <span class="n">config_tags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
            <span class="n">makefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_makefile</span><span class="p">(</span><span class="n">config_tags</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">makefile</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No TAU makefile approximately matches tags &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">config_tags</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">SoftwarePackageError</span><span class="p">(</span><span class="s2">&quot;TAU Makefile not found for tags &#39;</span><span class="si">%s</span><span class="s2">&#39; in &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_tags</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">install_prefix</span><span class="p">))</span>
        <span class="n">makefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lib_path</span><span class="p">,</span> <span class="n">makefile</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found TAU makefile </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">makefile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tau_makefile</span> <span class="o">=</span> <span class="n">makefile</span>
        <span class="k">return</span> <span class="n">makefile</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_sanitize_environment</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unsets any TAU environment variables that were set by the user.</span>

<span class="sd">        A user&#39;s preexisting TAU configuration may conflict with the configuration</span>
<span class="sd">        specified by the TAU Commander project.  This routine lets us work in a</span>
<span class="sd">        clean environment without disrupting the user&#39;s shell environment.</span>

<span class="sd">        Args:</span>
<span class="sd">            env (dict): Environment variables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: `env` without TAU environment variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_tau_var</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;TAU_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SCOREP_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;PROFILEDIR&#39;</span><span class="p">,</span> <span class="s1">&#39;TRACEDIR&#39;</span><span class="p">)</span>
        <span class="n">dirt</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">is_tau_var</span><span class="p">(</span><span class="n">key</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">dirt</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Ignoring TAU environment variables set in user&#39;s environment:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dirt</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()]))</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dirt</span><span class="p">])</span>

<div class="viewcode-block" id="TauInstallation.compiletime_config"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.compiletime_config">[docs]</a>    <span class="k">def</span> <span class="nf">compiletime_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configures environment for compilation with TAU.</span>

<span class="sd">        Modifies incoming command line arguments and environment variables</span>
<span class="sd">        for the TAU compiler wrapper scripts.</span>

<span class="sd">        Args:</span>
<span class="sd">            opts (list): Command line options.</span>
<span class="sd">            env (dict): Environment variables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (opts, env) updated to support TAU.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The additional `compiler` argument is needed to TAU falls back to the right compiler</span>
        <span class="c1"># pylint: disable=arguments-differ</span>
        <span class="n">opts</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">TauInstallation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">compiletime_config</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_environment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">opts</span><span class="p">,</span> <span class="n">env</span>
        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">opts</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">compiletime_config</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">tau_opts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">force_tau_options</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tau_opts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_OPTIONS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">tau_opts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tau_opts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_tau_options</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">tau_opts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_inst</span> <span class="o">!=</span> <span class="s1">&#39;never&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler_inst</span> <span class="o">!=</span> <span class="s1">&#39;never&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="s1">&#39;-optAppCC&#39;</span><span class="p">,</span> <span class="s1">&#39;-optAppCXX&#39;</span><span class="p">,</span> <span class="s1">&#39;-optAppF90&#39;</span><span class="p">:</span>
                    <span class="n">tau_opts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">flag</span><span class="o">+</span><span class="s1">&#39;=&#39;</span><span class="o">+</span><span class="n">compiler</span><span class="o">.</span><span class="n">absolute_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_inst</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_inst</span> <span class="o">==</span> <span class="s1">&#39;never&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler_inst</span> <span class="o">==</span> <span class="s1">&#39;never&#39;</span><span class="p">):</span>
                <span class="n">tau_opts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;-optLinkOnly&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tau_opts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;-optRevert&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">tau_opts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;-optVerbose&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler_inst</span> <span class="o">==</span> <span class="s1">&#39;always&#39;</span><span class="p">:</span>
                <span class="n">tau_opts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;-optCompInst&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler_inst</span> <span class="o">==</span> <span class="s1">&#39;never&#39;</span><span class="p">:</span>
                <span class="n">tau_opts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;-optNoCompInst&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler_inst</span> <span class="o">==</span> <span class="s1">&#39;fallback&#39;</span><span class="p">:</span>
                <span class="n">tau_opts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;-optRevert&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_inst_files</span><span class="p">:</span>
                <span class="n">tau_opts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;-optKeepFiles&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reuse_inst_files</span><span class="p">:</span>
                <span class="n">tau_opts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;-optReuseFiles&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_file</span><span class="p">:</span>
                <span class="n">select_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_file</span><span class="p">))</span>
                <span class="n">tau_opts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;-optTauSelectFile=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">select_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_io</span><span class="p">:</span>
                <span class="n">tau_opts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;-optTrackIO&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_memory_alloc</span><span class="p">:</span>
                <span class="n">tau_opts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;-optMemDbg&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">openmp_support</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_inst</span> <span class="o">==</span> <span class="s1">&#39;automatic&#39;</span><span class="p">:</span>
                <span class="n">tau_opts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;-optContinueBeforeOMP&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">LOG_LEVEL</span> <span class="o">!=</span> <span class="s1">&#39;DEBUG&#39;</span><span class="p">:</span>
                <span class="n">tau_opts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;-optQuiet&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler_inst</span> <span class="o">!=</span> <span class="s1">&#39;never&#39;</span><span class="p">:</span>
                <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_inst</span> <span class="o">!=</span> <span class="s1">&#39;never&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">compilers</span><span class="p">[</span><span class="n">CC</span><span class="p">]</span><span class="o">.</span><span class="n">unwrap</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">family</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">IBM</span><span class="p">:</span>
                <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-DTAU_ENABLED=1&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">extra_tau_opts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_tau_options</span><span class="p">)</span>
            <span class="n">tau_opts</span> <span class="o">|=</span> <span class="n">extra_tau_opts</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_OPTIONS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tau_opts</span><span class="p">)</span>
        <span class="n">makefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_makefile</span><span class="p">()</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makefile_tags</span><span class="p">(</span><span class="n">makefile</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to verify compiler compatibility of TAU makefile &#39;</span><span class="si">%s</span><span class="s2">&#39;.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;This might be OK, but it is your responsibility to know that TAU was configured &quot;</span>
                           <span class="s2">&quot;correctly for your experiment. Compiler incompatibility may cause your experiment &quot;</span>
                           <span class="s2">&quot;to crash or produce invalid data.  If you&#39;re unsure, use --tau=download to allow &quot;</span>
                           <span class="s2">&quot;TAU Commander to manage your TAU configurations.&quot;</span><span class="p">,</span> <span class="n">makefile</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_MAKEFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">makefile</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">opts</span><span class="p">)),</span> <span class="n">env</span></div>


<div class="viewcode-block" id="TauInstallation.runtime_config"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.runtime_config">[docs]</a>    <span class="k">def</span> <span class="nf">runtime_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configures environment for execution with TAU.</span>

<span class="sd">        Modifies incoming command line arguments and environment variables</span>
<span class="sd">        for the TAU library and tau_exec script.</span>

<span class="sd">        Args:</span>
<span class="sd">            opts (list): Command line options.</span>
<span class="sd">            env (dict): Environment variables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (opts, env) updated to support TAU.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opts</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">TauInstallation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">runtime_config</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_environment</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_VERBOSE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">==</span> <span class="s1">&#39;tau&#39;</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_PROFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">==</span> <span class="s1">&#39;merged&#39;</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_PROFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_PROFILE_FORMAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;merged&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">==</span> <span class="s1">&#39;cubex&#39;</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;SCOREP_ENABLE_PROFILING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_PROFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;SCOREP_ENABLE_PROFILING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;false&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">==</span> <span class="s1">&#39;slog2&#39;</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_TRACE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">==</span> <span class="s1">&#39;otf2&#39;</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_TRACE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_TRACE_FORMAT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;otf2&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_TRACE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;SCOREP_ENABLE_TRACING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;false&#39;</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_SAMPLING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">:</span>
            <span class="c1"># Based on periods shown in TauEnv.cpp as of tau2/e481b2bbc98c014a225d79bc4d0959b203d840d4</span>
            <span class="n">arch_period</span> <span class="o">=</span> <span class="p">{</span><span class="n">INTEL_KNC</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
                           <span class="n">INTEL_KNL</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
                           <span class="n">IBM_BGL</span><span class="p">:</span> <span class="mi">20000</span><span class="p">,</span>
                           <span class="n">IBM_BGP</span><span class="p">:</span> <span class="mi">20000</span><span class="p">,</span>
                           <span class="n">IBM_BGQ</span><span class="p">:</span> <span class="mi">50000</span><span class="p">}</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_EBS_PERIOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">arch_period</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_TRACK_HEAP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measure_heap_usage</span><span class="p">))</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_TRACK_LOAD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measure_system_load</span><span class="p">))</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_COMM_MATRIX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measure_comm_matrix</span><span class="p">))</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_CALLSITE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measure_callsite</span><span class="p">))</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_METRICS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_THROTTLE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">throttle</span><span class="p">))</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_MERGE_METADATA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_merge</span><span class="p">))</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_TRACK_MEMORY_FOOTPRINT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_memory_footprint</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">throttle</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_THROTTLE_PERCALL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">throttle_per_call</span><span class="p">))</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_THROTTLE_NUMCALLS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">throttle_num_calls</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callpath_depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_CALLPATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_CALLPATH_DEPTH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callpath_depth</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unwind_depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_EBS_UNWIND&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_EBS_UNWIND_DEPTH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unwind_depth</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_file</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">application_linkage</span> <span class="o">==</span> <span class="s1">&#39;dynamic&#39;</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_SELECT_FILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">:</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-ebs&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_cuda</span><span class="p">:</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-cupti&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_opencl</span><span class="p">:</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-opencl&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_openmp</span> <span class="o">==</span> <span class="s1">&#39;ompt&#39;</span><span class="p">:</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-ompt&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_ompt_tr6</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_OMPT_RESOLVE_ADDRESS_EAGERLY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_io</span><span class="p">:</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-io&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_memory_alloc</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;TAU_SHOW_MEMORY_FUNCTIONS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-memory&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_shmem</span><span class="p">:</span>
            <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-shmem&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">opts</span><span class="p">)),</span> <span class="n">env</span></div>

<div class="viewcode-block" id="TauInstallation.get_compiler_command"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.get_compiler_command">[docs]</a>    <span class="k">def</span> <span class="nf">get_compiler_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the compiler wrapper command for the given compiler.</span>

<span class="sd">        Args:</span>
<span class="sd">            compiler (InstalledCompiler): A compiler to find a wrapper for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Command for TAU compiler wrapper without path or arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">use_wrapper</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span> <span class="ow">and</span>
                       <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_inst</span> <span class="o">!=</span> <span class="s1">&#39;never&#39;</span> <span class="ow">or</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">compiler_inst</span> <span class="o">!=</span> <span class="s1">&#39;never&#39;</span> <span class="ow">or</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">measure_openmp</span> <span class="o">==</span> <span class="s1">&#39;opari&#39;</span> <span class="ow">or</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">application_linkage</span> <span class="o">==</span> <span class="s1">&#39;static&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">use_wrapper</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TAU_COMPILER_WRAPPERS</span><span class="p">[</span><span class="n">compiler</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">role</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="n">absolute_path</span></div>

<div class="viewcode-block" id="TauInstallation.compile"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.compile">[docs]</a>    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">compiler_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Executes a compilation command.</span>

<span class="sd">        Sets TAU environment variables and configures TAU compiler wrapper</span>
<span class="sd">        command line arguments to match specified configuration, then</span>
<span class="sd">        executes the compiler command.</span>

<span class="sd">        Args:</span>
<span class="sd">            compiler (InstalledCompiler): A compiler command.</span>
<span class="sd">            compiler_args (list): Compiler command line arguments.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ConfigurationError: Compilation failed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Compiler return value (always 0 if no exception raised).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>
        <span class="n">opts</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiletime_config</span><span class="p">(</span><span class="n">compiler</span><span class="p">)</span>
        <span class="n">compiler_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compiler_command</span><span class="p">(</span><span class="n">compiler</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">compiler_cmd</span><span class="p">]</span> <span class="o">+</span> <span class="n">opts</span> <span class="o">+</span> <span class="n">compiler_args</span>
        <span class="n">tau_env_opts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;TAU_&#39;</span><span class="p">))</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tau_env_opts</span><span class="p">))</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">create_subprocess</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;TAU was unable to build the application.&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;Check that the application builds with its normal compilers, i.e. without TAU.&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;Use taucmdr --log and see detailed output at the end of &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">logger</span><span class="o">.</span><span class="n">LOG_FILE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span></div>

    <span class="k">def</span> <span class="nf">_rewrite_launcher_appfile_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">tau_exec</span><span class="p">):</span>
        <span class="n">launcher</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">appfile_flags</span> <span class="o">=</span> <span class="n">PROGRAM_LAUNCHERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">launcher</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">appfile_flags</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InternalError</span><span class="p">(</span><span class="s2">&quot;Application configuration file flags for &#39;</span><span class="si">%s</span><span class="s2">&#39; are unknown&quot;</span> <span class="o">%</span> <span class="n">launcher</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">flag</span><span class="p">,</span> <span class="n">appfile</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
                <span class="n">with_equals</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">appfile</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">with_equals</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InternalError</span><span class="p">(</span><span class="s2">&quot;Unable to parse application configuration file in &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">appfile_flags</span><span class="p">:</span>
                <span class="n">appfile_arg_idx</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">appfile_flag</span> <span class="o">=</span> <span class="n">flag</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InternalError</span><span class="p">(</span><span class="s2">&quot;None of &#39;</span><span class="si">%s</span><span class="s2">&#39; found in &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">appfile_flags</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
        <span class="n">tau_appfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(),</span> <span class="n">appfile</span><span class="o">+</span><span class="s2">&quot;.tau&quot;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Rewriting &#39;</span><span class="si">%s</span><span class="s2">&#39; as &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">appfile</span><span class="p">,</span> <span class="n">tau_appfile</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tau_appfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">appfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">application_cmd</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">launcher</span> <span class="o">==</span> <span class="s1">&#39;srun&#39;</span><span class="p">:</span>
                    <span class="c1"># Slurm makes this easy: https://computing.llnl.gov/tutorials/linux_clusters/multi-prog.html</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exe</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">application_cmd</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">exe</span><span class="p">):</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;No executables found on line </span><span class="si">%d</span><span class="s2"> of &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="n">appfile</span><span class="p">),</span>
                                                 <span class="s2">&quot;Check the file for errors. Does it work without TAU?&quot;</span><span class="p">,</span>
                                                 <span class="s2">&quot;Avoid breaking commands over multiple lines.&quot;</span><span class="p">)</span>
                <span class="n">tau_line</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">application_cmd</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">tau_exec</span> <span class="o">+</span> <span class="n">application_cmd</span><span class="p">[</span><span class="n">idx</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">])</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">tau_line</span><span class="p">)</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tau_line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_equals</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cmd</span><span class="p">[:</span><span class="n">appfile_arg_idx</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">appfile_flag</span><span class="o">+</span><span class="s1">&#39;=&#39;</span><span class="o">+</span><span class="n">tau_appfile</span><span class="p">]</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="n">appfile_arg_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cmd</span><span class="p">[:</span><span class="n">appfile_arg_idx</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">appfile_flag</span><span class="p">,</span> <span class="n">tau_appfile</span><span class="p">]</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="n">appfile_arg_idx</span><span class="o">+</span><span class="mi">2</span><span class="p">:]</span>
        
<div class="viewcode-block" id="TauInstallation.get_application_command"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.get_application_command">[docs]</a>    <span class="k">def</span> <span class="nf">get_application_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">launcher_cmd</span><span class="p">,</span> <span class="n">application_cmds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a command line to launch an application under TAU.</span>

<span class="sd">        Sometimes TAU needs to use tau_exec, sometimes not.  This routine</span>
<span class="sd">        also handles backend launch commands like ``aprun``.</span>

<span class="sd">        `application_cmds` may be an empty list if the application is launched</span>
<span class="sd">        via a configuration file, e.g. ``mpirun --app myapp.cfg``.</span>

<span class="sd">        Args:</span>
<span class="sd">            launcher_cmd (list): Application launcher with command line arguments, e.g. ``[&#39;mpirun&#39;, &#39;-np&#39;, &#39;4&#39;]``.</span>
<span class="sd">            application_cmds (list): List of application command with command line arguments (list of list),</span>
<span class="sd">                                     e.g. ``[[&#39;./a.out&#39;, &#39;-g&#39;, &#39;hello&#39;], [&#39;:&#39;, &#39;-np&#39;, &#39;2&#39;, &#39;./b.out&#39;, &#39;foobar&#39;]]``</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (cmd, env) where `cmd` is the new command line and `env` is a dictionary of environment</span>
<span class="sd">                   variables to set before running the application command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>
        <span class="n">opts</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_config</span><span class="p">()</span>
        <span class="c1"># Per Sameer&#39;s request, shim in site-specific flags.  </span>
        <span class="c1"># These should be specified in a taucmdr module or similar.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">launcher_cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;__TAUCMDR_LAUNCHER_ARGS__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tau_baseline&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">launcher_cmd</span>
            <span class="k">for</span> <span class="n">application_cmd</span> <span class="ow">in</span> <span class="n">application_cmds</span><span class="p">:</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">application_cmd</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">env</span>
        <span class="n">use_tau_exec</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">application_linkage</span> <span class="o">!=</span> <span class="s1">&#39;static&#39;</span> <span class="ow">and</span> 
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">source_inst</span> <span class="o">==</span> <span class="s1">&#39;never&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler_inst</span> <span class="o">==</span> <span class="s1">&#39;never&#39;</span><span class="p">)</span> <span class="ow">or</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">measure_opencl</span> <span class="ow">or</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">tbb_support</span> <span class="ow">or</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">pthreads_support</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_tau_exec</span><span class="p">:</span>
            <span class="n">tau_exec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">makefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_makefile</span><span class="p">()</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makefile_tags</span><span class="p">(</span><span class="n">makefile</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_support</span><span class="p">:</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">unmanaged</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to verify runtime compatibility of TAU makefile &#39;</span><span class="si">%s</span><span class="s2">&#39;.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;This might be OK, but it is your responsibility to know that TAU was configured &quot;</span>
                               <span class="s2">&quot;correctly for your experiment. Runtime incompatibility may cause your experiment &quot;</span>
                               <span class="s2">&quot;to crash or produce invalid data.  If you&#39;re unsure, use &#39;--tau=download&#39; when &quot;</span>
                               <span class="s2">&quot;creating your target to allow TAU Commander to manage your TAU configurations.&quot;</span><span class="p">,</span> 
                               <span class="n">makefile</span><span class="p">)</span>
            <span class="n">tau_exec</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tau_exec&#39;</span><span class="p">,</span> <span class="s1">&#39;-T&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tags</span><span class="p">)]</span> <span class="o">+</span> <span class="n">opts</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">application_cmds</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_launcher_appfile_cmd</span><span class="p">(</span><span class="n">launcher_cmd</span><span class="p">,</span> <span class="n">tau_exec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">launcher_cmd</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tau_exec</span><span class="p">)</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">application_cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">application_cmd</span> <span class="ow">in</span> <span class="n">application_cmds</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">application_cmd</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
                        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">application_cmd</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tau_exec</span><span class="p">)</span>
                        <span class="n">cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">application_cmd</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InternalError</span><span class="p">(</span><span class="s2">&quot;Application command &#39;</span><span class="si">%s</span><span class="s2">&#39; contains no executables&quot;</span> <span class="o">%</span> <span class="n">application_cmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">env</span></div>
    
    <span class="k">def</span> <span class="nf">_check_java</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s1">&#39;java&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">abspath</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;&#39;java&#39; not found in PATH&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_command_output</span><span class="p">([</span><span class="n">abspath</span><span class="p">,</span> <span class="s1">&#39;-version&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Failed to get Java version: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Java(TM)&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; does not appear to be Oracle Java.  Visual performance may be poor.&quot;</span><span class="p">,</span> <span class="n">abspath</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_check_X11</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pylint: disable=invalid-name</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_config</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">display</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;DISPLAY&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;X11 display not configured.&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;Try setting the DISPLAY environment variable.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">host</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">display</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot parse DISPLAY environment variable.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">host</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">host</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;X11 appears to be forwarded to a remote display. Visual performance may be poor.&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="TauInstallation.get_data_format"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.get_data_format">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Guess the data format of a file path.</span>
<span class="sd">        </span>
<span class="sd">        Look at a file&#39;s extension and guess what kind of performance data it might be.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            path (str): File path.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: String indicating the data format.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            ConfigurationError: Cannot determine the file&#39;s data format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">root</span> <span class="o">==</span> <span class="s1">&#39;profile&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;tau&#39;</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.ppk&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;ppk&#39;</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.xml&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;merged&#39;</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.cubex&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;cubex&#39;</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.slog2&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;slog2&#39;</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.otf2&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;otf2&#39;</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
            <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.xml&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;merged&#39;</span>
        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Cannot determine data format of &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="TauInstallation.is_profile_format"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.is_profile_format">[docs]</a>    <span class="k">def</span> <span class="nf">is_profile_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if ``fmt`` is a string indicating a profile data format.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tau&#39;</span><span class="p">,</span> <span class="s1">&#39;ppk&#39;</span><span class="p">,</span> <span class="s1">&#39;merged&#39;</span><span class="p">,</span> <span class="s1">&#39;cubex&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TauInstallation.is_trace_format"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.is_trace_format">[docs]</a>    <span class="k">def</span> <span class="nf">is_trace_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if ``fmt`` is a string indicating a trace data format.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;slog2&#39;</span><span class="p">,</span> <span class="s1">&#39;otf2&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_show_unknown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">launcher</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span><span class="p">]</span> <span class="o">+</span> <span class="n">paths</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; not supported. Trying command &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">create_subprocess</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">CalledProcessError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">launcher</span>

    <span class="k">def</span> <span class="nf">_show_paraprof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_java</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_X11</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Profile file &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;tau&#39;</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                <span class="n">retval</span> <span class="o">+=</span> <span class="n">util</span><span class="o">.</span><span class="n">create_subprocess</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_path</span><span class="p">,</span> <span class="s1">&#39;paraprof&#39;</span><span class="p">)],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">retval</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">create_subprocess</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_path</span><span class="p">,</span> <span class="s1">&#39;paraprof&#39;</span><span class="p">)]</span> <span class="o">+</span> <span class="n">paths</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_show_pprof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">!=</span> <span class="s1">&#39;tau&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;pprof cannot open profiles in &#39;</span><span class="si">%s</span><span class="s2">&#39; format&quot;</span> <span class="o">%</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Profile directory &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">thisdir</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;profile&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">):</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Current trial/metric directory: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">thisdir</span><span class="p">))</span>
                    <span class="n">retval</span> <span class="o">+=</span> <span class="n">util</span><span class="o">.</span><span class="n">create_subprocess</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_path</span><span class="p">,</span> <span class="s1">&#39;pprof&#39;</span><span class="p">),</span> <span class="s1">&#39;-a&#39;</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">thisdir</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;No profile files found in &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span>
    
    <span class="k">def</span> <span class="nf">_show_jumpshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">!=</span> <span class="s1">&#39;slog2&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;jumpshot cannot open traces in &#39;</span><span class="si">%s</span><span class="s2">&#39; format&quot;</span> <span class="o">%</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_java</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_X11</span><span class="p">()</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Trace file &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">retval</span> <span class="o">+=</span> <span class="n">util</span><span class="o">.</span><span class="n">create_subprocess</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_path</span><span class="p">,</span> <span class="s1">&#39;jumpshot&#39;</span><span class="p">),</span> <span class="n">path</span><span class="p">],</span> 
                                             <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span>
    
    <span class="k">def</span> <span class="nf">_show_vampir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">!=</span> <span class="s1">&#39;otf2&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Vampir cannot open traces in &#39;</span><span class="si">%s</span><span class="s2">&#39; format&quot;</span> <span class="o">%</span> <span class="n">fmt</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s1">&#39;vampir&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Vampir not found in PATH.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_java</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_X11</span><span class="p">()</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Trace file &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">evt_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="s1">&#39;traces/*.evt&#39;</span><span class="p">))</span>
            <span class="n">def_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="s1">&#39;traces/*.def&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evt_files</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">def_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_NOFILE</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Too many trace files, use vampirserver to view.&quot;</span><span class="p">)</span>
            <span class="n">retval</span> <span class="o">+=</span> <span class="n">util</span><span class="o">.</span><span class="n">create_subprocess</span><span class="p">([</span><span class="s1">&#39;vampir&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span>
    
<div class="viewcode-block" id="TauInstallation._prep_data_analysis_tools"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation._prep_data_analysis_tools">[docs]</a>    <span class="k">def</span> <span class="nf">_prep_data_analysis_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks that data analysis tools are installed, or installs them if needed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lib_path</span><span class="p">,</span> <span class="s1">&#39;Makefile.tau*&#39;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">DATA_TOOLS</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_path</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">install</span><span class="p">()</span></div>

<div class="viewcode-block" id="TauInstallation.show_data_files"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.show_data_files">[docs]</a>    <span class="k">def</span> <span class="nf">show_data_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">profile_tools</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">trace_tools</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Displays profile and trace data.</span>
<span class="sd">        </span>
<span class="sd">        Opens one more more data analysis tools to display the specified data files. </span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            dataset (dict): Lists of paths to data files indexed by data format.  See :any:`get_data_format`.</span>
<span class="sd">            profile_tools (list): Visualization or data processing tools for profiles.</span>
<span class="sd">            trace_tools (list): Visualization or data processing tools for traces.</span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            ConfigurationError: An error occurred while displaying a data file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prep_data_analysis_tools</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_config</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">paths</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_profile_format</span><span class="p">(</span><span class="n">fmt</span><span class="p">):</span>
                <span class="n">tools</span> <span class="o">=</span> <span class="n">profile_tools</span> <span class="k">if</span> <span class="n">profile_tools</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">PROFILE_ANALYSIS_TOOLS</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_trace_format</span><span class="p">(</span><span class="n">fmt</span><span class="p">):</span>
                <span class="n">tools</span> <span class="o">=</span> <span class="n">trace_tools</span> <span class="k">if</span> <span class="n">trace_tools</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">TRACE_ANALYSIS_TOOLS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InternalError</span><span class="p">(</span><span class="s2">&quot;Unhandled data format &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">fmt</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">launcher</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_show_&#39;</span><span class="o">+</span><span class="n">tool</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">launcher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_unknown</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">retval</span> <span class="o">=</span> <span class="n">launcher</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">ConfigurationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> returned </span><span class="si">%d</span><span class="s2">, trying another tool&quot;</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">retval</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;All analysis tools failed&quot;</span><span class="p">,</span>
                                         <span class="s2">&quot;Check Java installation, X11 installation,&quot;</span>
                                         <span class="s2">&quot; network connectivity, and file permissions&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TauInstallation.create_ppk_file"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.create_ppk_file">[docs]</a>    <span class="k">def</span> <span class="nf">create_ppk_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">remove_existing</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a PPK file at ``dest`` from the data at ``src``.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            dest (str): Path to the PPK file to create.</span>
<span class="sd">            src (str): Directory containing TAU profiles to convert to PPK format.</span>
<span class="sd">            remove_existing (bool): If True, delete ``dest`` before writing it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prep_data_analysis_tools</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_java</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">remove_existing</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;paraprof&#39;</span><span class="p">,</span> <span class="s1">&#39;--pack&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="p">]</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing &#39;</span><span class="si">%s</span><span class="s2">&#39;...&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">create_subprocess</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; failed in &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">src</span><span class="p">),</span>
                                     <span class="s2">&quot;Make sure Java is installed and working&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;Install the most recent Java from http://java.com&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TauInstallation.merge_tau_trace_files"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.merge_tau_trace_files">[docs]</a>    <span class="k">def</span> <span class="nf">merge_tau_trace_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use tau_treemerge.pl to merge multiple TAU trace files into a single edf and a single trc file.</span>

<span class="sd">        The new edf file and trc file are written to ``prefix``.</span>

<span class="sd">        Args:</span>
<span class="sd">            prefix (str): Path to the directory containing ``*.trc`` and ``*.edf`` files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prep_data_analysis_tools</span><span class="p">()</span>
        <span class="n">trc_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;*.trc&#39;</span><span class="p">))</span>
        <span class="n">edf_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;*.edf&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trc_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;No *.trc files at &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">edf_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;No *.edf files at &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="n">merged_trc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;tau.trc&#39;</span><span class="p">)</span>
        <span class="n">merged_edf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;tau.edf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">merged_trc</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Remove &#39;</span><span class="si">%s</span><span class="s2">&#39; before merging *.trc files&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">merged_edf</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">&quot;Remove &#39;</span><span class="si">%s</span><span class="s2">&#39; before merging *.edf files&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_path</span><span class="p">,</span> <span class="s1">&#39;tau_treemerge.pl&#39;</span><span class="p">)]</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Merging </span><span class="si">%d</span><span class="s2"> TAU trace files...&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">trc_files</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">edf_files</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">create_subprocess</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InternalError</span><span class="p">(</span><span class="s2">&quot;Nonzero return code from tau_treemerge.pl&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TauInstallation.tau_trace_to_slog2"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.tau_trace_to_slog2">[docs]</a>    <span class="k">def</span> <span class="nf">tau_trace_to_slog2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">edf</span><span class="p">,</span> <span class="n">slog2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a TAU trace file to SLOG2 format.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            trc (str): Path to the trc file.</span>
<span class="sd">            edf (str): Path to the edf file.</span>
<span class="sd">            slog2 (str): Path to the slog2 file to create.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prep_data_analysis_tools</span><span class="p">()</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting TAU trace files to SLOG2 format...&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_path</span><span class="p">,</span> <span class="s1">&#39;tau2slog2&#39;</span><span class="p">),</span> <span class="n">trc</span><span class="p">,</span> <span class="n">edf</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">slog2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">create_subprocess</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">slog2</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InternalError</span><span class="p">(</span><span class="s2">&quot;Nonzero return code from tau2slog2&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">slog2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InternalError</span><span class="p">(</span><span class="s2">&quot;Failed to convert TAU trace data: no slog2 files exist after calling &#39;tau2slog2&#39;&quot;</span><span class="p">)</span>                </div>

<div class="viewcode-block" id="TauInstallation.tau_metrics"><a class="viewcode-back" href="../../../../taucmdr.cf.software.tau_installation.html#taucmdr.cf.software.tau_installation.TauInstallation.tau_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">tau_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List TAU metrics available on this target.</span>
<span class="sd">        </span>
<span class="sd">        Returns a list of (name, description) tuples.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            list: List of event name/description tuples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;LOGICAL_CLOCK&quot;</span><span class="p">,</span> <span class="s2">&quot;Logical clock that increments on each request.&quot;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s2">&quot;USER_CLOCK&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;User-defined clock. Implement &quot;</span>
                                   <span class="s2">&quot;&#39;void metric_write_userClock(int tid, double value)&#39;  to set the clock value.&quot;</span><span class="p">)),</span>
                   <span class="p">(</span><span class="s2">&quot;GET_TIME_OF_DAY&quot;</span><span class="p">,</span> <span class="s2">&quot;Wall clock that calls gettimeofday.&quot;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s2">&quot;TIME&quot;</span><span class="p">,</span> <span class="s2">&quot;Alias for GET_TIME_OF_DAY. Wall clock that calls gettimeofday.&quot;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s2">&quot;CLOCK_GET_TIME&quot;</span><span class="p">,</span> <span class="s2">&quot;Wall clock that calls clock_gettime.&quot;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s2">&quot;P_WALL_CLOCK_TIME&quot;</span><span class="p">,</span> <span class="s2">&quot;Wall clock that calls PAPI_get_real_usec.&quot;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s2">&quot;PAPI_TIME&quot;</span><span class="p">,</span> <span class="s2">&quot;Alias for P_WALL_CLOCK_TIME.  Wall clock that calls PAPI_get_real_usec.&quot;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s2">&quot;P_VIRTUAL_TIME&quot;</span><span class="p">,</span> <span class="s2">&quot;PAPI virtual clock that calls PAPI_get_virt_usec.&quot;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s2">&quot;PAPI_VIRTUAL_TIME&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Alias for P_VIRTUAL_TIME.  &quot;</span>
                                          <span class="s2">&quot;PAPI virtual clock that calls PAPI_get_virt_usec.&quot;</span><span class="p">)),</span>
                   <span class="p">(</span><span class="s2">&quot;CPU_TIME&quot;</span><span class="p">,</span> <span class="s2">&quot;CPU timer that calls getrusage.&quot;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s2">&quot;LINUX_TIMERS&quot;</span><span class="p">,</span> <span class="s2">&quot;Linux high resolution wall clock.&quot;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s2">&quot;TAU_MPI_MESSAGE_SIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;Running sum of all MPI messsage sizes.&quot;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s2">&quot;MEMORY_DELTA&quot;</span><span class="p">,</span> <span class="s2">&quot;Instantaneous resident set size (RSS)&quot;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cuda_support</span><span class="p">:</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;TAUGPU_TIME&quot;</span><span class="p">,</span> <span class="s2">&quot;Wall clock that uses TAU&#39;s GPU timestamps.&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_os</span> <span class="ow">is</span> <span class="n">CRAY_CNL</span><span class="p">:</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="s2">&quot;CRAY_TIMERS&quot;</span><span class="p">,</span> <span class="s2">&quot;Cray high resolution clock.&quot;</span><span class="p">),</span>
                            <span class="p">(</span><span class="s2">&quot;ENERGY&quot;</span><span class="p">,</span> <span class="s2">&quot;Cray Power Monitoring: /sys/cray/pm_counters/energy&quot;</span><span class="p">),</span>
                            <span class="p">(</span><span class="s2">&quot;ACCEL_ENERGY&quot;</span><span class="p">,</span> <span class="s2">&quot;Cray Power Monitoring: /sys/cray/pm_counters/accel_energy&quot;</span><span class="p">)])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span> <span class="ow">is</span> <span class="n">IBM_BGL</span><span class="p">:</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;BGL_TIMERS&quot;</span><span class="p">,</span> <span class="s2">&quot;BlueGene/L high resolution clock.&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span> <span class="ow">is</span> <span class="n">IBM_BGP</span><span class="p">:</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;BGP_TIMERS&quot;</span><span class="p">,</span> <span class="s2">&quot;BlueGene/P high resolution clock.&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_arch</span> <span class="ow">is</span> <span class="n">IBM_BGQ</span><span class="p">:</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;BGQ_TIMERS&quot;</span><span class="p">,</span> <span class="s2">&quot;BlueGene/Q high resolution clock.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">metrics</span></div></div>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2015 ParaTools, Inc..
      Last updated on Sep 09, 2018 at 19:09:34 UTC.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
  </body>
</html>