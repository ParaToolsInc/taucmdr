<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>taucmdr.mvc.controller &mdash; TAU Commander Developer Documentation</title>
    
    <link rel="stylesheet" href="../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.0.0
',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="top" title="TAU Commander Developer Documentation" href="../../../index.html" />
    <link rel="up" title="taucmdr" href="../../taucmdr.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><img class="rightlogo" src="../../../_static/taulogo-large.png" alt="Logo"/><h1 class="heading"><a href="../../../index.html">
          <span>TAU Commander Developer Documentation</span></a></h1>
        <h2 class="heading"><span>taucmdr.mvc.controller</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for taucmdr.mvc.controller</h1><div class="highlight"><pre>
<span></span><span class="c1">#.language</span>
<span class="c1"># Copyright (c) 2015, ParaTools, Inc.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1"># (1) Redistributions of source code must retain the above copyright notice,</span>
<span class="c1">#     this list of conditions and the following disclaimer.</span>
<span class="c1"># (2) Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#     this list of conditions and the following disclaimer in the documentation</span>
<span class="c1">#     and/or other materials provided with the distribution.</span>
<span class="c1"># (3) Neither the name of ParaTools, Inc. nor the names of its contributors may</span>
<span class="c1">#     be used to endorse or promote products derived from this software without</span>
<span class="c1">#     specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c1"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c1"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="c1"># DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span>
<span class="c1"># FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="c1"># DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span class="c1"># SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<span class="c1"># CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="c1"># OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="c1"># OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;TODO: FIXME: Docs&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">taucmdr</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">taucmdr</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">taucmdr.error</span> <span class="kn">import</span> <span class="n">InternalError</span><span class="p">,</span> <span class="n">UniqueAttributeError</span><span class="p">,</span> <span class="n">ModelError</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Suppress debugging messages in optimized code</span>
<span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
    <span class="n">_heavy_debug</span> <span class="o">=</span> <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span>   <span class="c1"># pylint: disable=invalid-name</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">_heavy_debug</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="valid"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.valid">[docs]</a><span class="k">def</span> <span class="nf">valid</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_has</span><span class="p">(</span><span class="n">requirement</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">requirement</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">field</span> <span class="o">==</span> <span class="n">requirement</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">requirement</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">field</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_has</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">context</span><span class="p">]</span></div>

<div class="viewcode-block" id="contextualize"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.contextualize">[docs]</a><span class="k">def</span> <span class="nf">contextualize</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># Context can be True, False, or list(key, value)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="c1"># If True, use the default context</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>

        <span class="n">records</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">records</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">records</span> <span class="o">=</span> <span class="n">records</span> <span class="k">if</span> <span class="n">valid</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">records</span> <span class="k">if</span> <span class="n">valid</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">e</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">records</span>
    <span class="k">return</span> <span class="n">wrapper</span></div>

<div class="viewcode-block" id="Controller"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller">[docs]</a><span class="k">class</span> <span class="nc">Controller</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The &quot;C&quot; in `MVC`_.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        model (AbstractModel): Data model.</span>
<span class="sd">        storage (AbstractDatabase): Record storage.</span>

<span class="sd">        context (List(Tuple)): A field filter, with syntax (key, value).</span>
<span class="sd">        Filtering according to a context means that only elements with</span>
<span class="sd">        at least an element matching the rules set in the context will</span>
<span class="sd">        be considered. Think of it as a whitelist.</span>
<span class="sd">        A controller will filters results according to:</span>
<span class="sd">        - By default, nothing;</span>
<span class="sd">        - If a context was given at the object&#39;s initialization,</span>
<span class="sd">            the controller only allows objects matching the context;</span>
<span class="sd">        - If a context is given during a command, it overrides the internal</span>
<span class="sd">            context and the results are matched against it.</span>

<span class="sd">    .. _MVC: https://en.wikipedia.org/wiki/Model-view-controller</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_cls</span><span class="p">,</span> <span class="n">storage</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Controller.push_to_topic"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.push_to_topic">[docs]</a>    <span class="k">def</span> <span class="nf">push_to_topic</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Controller.pop_topic"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.pop_topic">[docs]</a>    <span class="k">def</span> <span class="nf">pop_topic</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">topic</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="p">[])</span></div>

    <span class="nd">@contextualize</span>
<div class="viewcode-block" id="Controller.one"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.one">[docs]</a>    <span class="k">def</span> <span class="nf">one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a record.</span>

<span class="sd">        Args:</span>
<span class="sd">            key: See :any:`AbstractStorage.get`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Model: The model for the matching record or None if no such record exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="k">if</span> <span class="n">record</span> <span class="k">else</span> <span class="kc">None</span></div>

    <span class="nd">@contextualize</span>
<div class="viewcode-block" id="Controller.all"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.all">[docs]</a>    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all records.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Models for all records or an empty lists if no records exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Controller.count"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of records.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Effectively ``len(self.all())``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=unexpected-keyword-arg</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">))</span></div>

    <span class="nd">@contextualize</span>
<div class="viewcode-block" id="Controller.search"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.search">[docs]</a>    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return records that have all given keys.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: See :any:`AbstractStorage.search`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Models for records with the given keys or an empty lists if no records have all keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span></div>

    <span class="nd">@contextualize</span>
<div class="viewcode-block" id="Controller.match"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return records that have a field matching a regular expression or test function.</span>

<span class="sd">        Args:</span>
<span class="sd">            field: See :any:`AbstractStorage.match`.</span>
<span class="sd">            regex: See :any:`AbstractStorage.match`.</span>
<span class="sd">            test: See :any:`AbstractStorage.match`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Models for records that have a matching field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">field</span><span class="p">,</span>
                                                 <span class="n">table_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                 <span class="n">regex</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
                                                 <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Controller.exists"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.exists">[docs]</a>    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if a record exists.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys: See :any:`AbstractStorage.exists`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if a record matching `keys` exists, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">relevant_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="k">else</span> <span class="n">context</span>
        <span class="k">if</span> <span class="n">relevant_context</span><span class="p">:</span>
            <span class="c1"># As the context is not exclusive, try with every filter</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">relevant_context</span><span class="p">:</span>
                <span class="n">modded_keys</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">modded_keys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">modded_keys</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Controller.populate"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.populate">[docs]</a>    <span class="k">def</span> <span class="nf">populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merges associated data into the model record.</span>

<span class="sd">        Example:</span>
<span class="sd">            Suppose we have the following Person records::</span>

<span class="sd">                1: {&#39;name&#39;: &#39;Katie&#39;, &#39;friends&#39;: [2, 3]}</span>
<span class="sd">                2: {&#39;name&#39;: &#39;Ryan&#39;, &#39;friends&#39;: [1]}</span>
<span class="sd">                3: {&#39;name&#39;: &#39;John&#39;, &#39;friends&#39;: [1]}</span>

<span class="sd">            Populating ``Person({&#39;name&#39;: &#39;Katie&#39;, &#39;friends&#39;: [2, 3]})`` produces this dictionary::</span>

<span class="sd">                {&#39;name&#39;: &#39;Katie&#39;,</span>
<span class="sd">                 &#39;friends&#39;: [Person({&#39;name&#39;: &#39;Ryan&#39;, &#39;friends&#39;: [1]}),</span>
<span class="sd">                             Person({&#39;name&#39;: &#39;John&#39;, &#39;friends&#39;: [1]}]})</span>

<span class="sd">        Args:</span>
<span class="sd">            attribute (Optional[str]): If given, return only the populated attribute.</span>
<span class="sd">            defaults (Optional[bool]): If given, set undefined attributes to their default values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            If attribute is None, a dictionary of controlled data merged with associated records.</span>
<span class="sd">            If attribute is not None, the value of the populated attribute.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: `attribute` is undefined in the record.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attribute</span><span class="p">:</span>
            <span class="n">_heavy_debug</span><span class="p">(</span><span class="s2">&quot;Populating </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)[</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populate_attribute</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="n">_heavy_debug</span><span class="p">(</span><span class="s2">&quot;Populating </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populate_attribute</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">model</span><span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">_populate_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">props</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;no attribute &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">defaults</span> <span class="ow">or</span> <span class="s1">&#39;default&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">foreign</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">foreign</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">foreign</span><span class="o">.</span><span class="n">controller</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">foreign</span><span class="o">.</span><span class="n">controller</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_unique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">match_any</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">props</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;unique&#39;</span> <span class="ow">in</span> <span class="n">props</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">unique</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">unique</span><span class="p">,</span> <span class="n">match_any</span><span class="o">=</span><span class="n">match_any</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UniqueAttributeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">unique</span><span class="p">)</span>

<div class="viewcode-block" id="Controller.create"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Atomically store a new record and update associations.</span>

<span class="sd">        Invokes the `on_create` callback **after** the data is recorded.  If this callback raises</span>
<span class="sd">        an exception then the operation is reverted.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (dict): Data to record.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Model: The newly created data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_unique</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="k">as</span> <span class="n">database</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">foreign</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">associations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">or</span> <span class="s1">&#39;collection&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">attr</span><span class="p">]:</span>
                    <span class="n">affected</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">affected</span><span class="p">:</span>
                        <span class="n">foreign_cls</span><span class="p">,</span> <span class="n">via</span> <span class="o">=</span> <span class="n">foreign</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_associate</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">foreign_cls</span><span class="p">,</span> <span class="n">affected</span><span class="p">,</span> <span class="n">via</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">check_compatibility</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">on_create</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="Controller.update"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change recorded data and update associations.</span>

<span class="sd">        The behavior depends on the type of `keys`:</span>
<span class="sd">            * Record.ElementIdentifier: update the record with that element identifier.</span>
<span class="sd">            * dict: update all records with attributes matching `keys`.</span>
<span class="sd">            * list or tuple: apply update to all records matching the elements of `keys`.</span>
<span class="sd">            * ``bool(keys) == False``: raise ValueError.</span>

<span class="sd">        Invokes the `on_update` callback **after** the data is modified.  If this callback raises</span>
<span class="sd">        an exception then the operation is reverted.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (dict): New data for existing records.</span>
<span class="sd">            keys: Fields or element identifiers to match.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">is_clean_container</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Binary data (bytes, bytearray, etc.) found in data(dict)!</span><span class="se">\n</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;no attribute named &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="k">as</span> <span class="n">database</span><span class="p">:</span>
            <span class="c1"># Get the list of affected records **before** updating the data so foreign keys are correct</span>
            <span class="n">old_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
            <span class="n">database</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">changes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">old_records</span><span class="p">:</span>
                <span class="n">changes</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="n">new_value</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                      <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">attr</span> <span class="ow">in</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="n">new_value</span><span class="p">)}</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">foreign</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">associations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># &#39;collection&#39; attribute is iterable</span>
                        <span class="n">new_foreign_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="c1"># &#39;model&#39; attribute is not iterable, so make a tuple</span>
                        <span class="n">new_foreign_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">data</span><span class="p">[</span><span class="n">attr</span><span class="p">]}</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># &#39;collection&#39; attribute is iterable</span>
                        <span class="n">old_foreign_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="c1"># &#39;model&#39; attribute is not iterable, so make a tuple</span>
                        <span class="n">old_foreign_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">model</span><span class="p">[</span><span class="n">attr</span><span class="p">]}</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">old_foreign_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="n">foreign_cls</span><span class="p">,</span> <span class="n">via</span> <span class="o">=</span> <span class="n">foreign</span>
                    <span class="n">added</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_foreign_keys</span> <span class="o">-</span> <span class="n">old_foreign_keys</span><span class="p">)</span>
                    <span class="n">deled</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">old_foreign_keys</span> <span class="o">-</span> <span class="n">new_foreign_keys</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">added</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_associate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">foreign_cls</span><span class="p">,</span> <span class="n">added</span><span class="p">,</span> <span class="n">via</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">deled</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_disassociate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">foreign_cls</span><span class="p">,</span> <span class="n">deled</span><span class="p">,</span> <span class="n">via</span><span class="p">)</span>
            <span class="n">updated_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">updated_records</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">check_compatibility</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">on_update</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">eid</span><span class="p">])</span></div>

<div class="viewcode-block" id="Controller.unset"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.unset">[docs]</a>    <span class="k">def</span> <span class="nf">unset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unset recorded data fields and update associations.</span>

<span class="sd">        The behavior depends on the type of `keys`:</span>
<span class="sd">            * Record.ElementIdentifier: update the record with that element identifier.</span>
<span class="sd">            * dict: update all records with attributes matching `keys`.</span>
<span class="sd">            * list or tuple: apply update to all records matching the elements of `keys`.</span>
<span class="sd">            * ``bool(keys) == False``: raise ValueError.</span>

<span class="sd">        Invokes the `on_update` callback **after** the data is modified.  If this callback raises</span>
<span class="sd">        an exception then the operation is reverted.</span>

<span class="sd">        Args:</span>
<span class="sd">            fields (list): Names of fields to unset.</span>
<span class="sd">            keys: Fields or element identifiers to match.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;no attribute named &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="k">as</span> <span class="n">database</span><span class="p">:</span>
            <span class="c1"># Get the list of affected records **before** updating the data so foreign keys are correct</span>
            <span class="n">old_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
            <span class="n">database</span><span class="o">.</span><span class="n">unset</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">changes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">old_records</span><span class="p">:</span>
                <span class="n">changes</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="p">:</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">model</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">foreign</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">associations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                        <span class="n">foreign_cls</span><span class="p">,</span> <span class="n">via</span> <span class="o">=</span> <span class="n">foreign</span>
                        <span class="n">old_foreign_keys</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">old_foreign_keys</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_disassociate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">foreign_cls</span><span class="p">,</span> <span class="n">old_foreign_keys</span><span class="p">,</span> <span class="n">via</span><span class="p">)</span>
            <span class="n">updated_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">updated_records</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">check_compatibility</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">on_update</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">eid</span><span class="p">])</span></div>

<div class="viewcode-block" id="Controller.delete"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete recorded data and update associations.</span>

<span class="sd">        The behavior depends on the type of `keys`:</span>
<span class="sd">            * Record.ElementIdentifier: delete the record with that element identifier.</span>
<span class="sd">            * dict: delete all records with attributes matching `keys`.</span>
<span class="sd">            * list or tuple: delete all records matching the elements of `keys`.</span>
<span class="sd">            * ``bool(keys) == False``: raise ValueError.</span>

<span class="sd">        Invokes the `on_delete` callback **after** the data is deleted.  If this callback raises</span>
<span class="sd">        an exception then the operation is reverted.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys (dict): Attributes to match.</span>
<span class="sd">            keys: Fields or element identifiers to match.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="k">as</span> <span class="n">database</span><span class="p">:</span>
            <span class="n">removed_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># pylint: disable=unexpected-keyword-arg</span>
            <span class="n">changing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">changing</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">foreign</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">associations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">foreign_model</span><span class="p">,</span> <span class="n">via</span> <span class="o">=</span> <span class="n">foreign</span>
                    <span class="n">affected_keys</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">affected_keys</span><span class="p">:</span>
                        <span class="n">_heavy_debug</span><span class="p">(</span><span class="s2">&quot;Deleting </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">) affects &#39;</span><span class="si">%s</span><span class="s2">&#39; in </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">via</span><span class="p">,</span> <span class="n">foreign_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">affected_keys</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_disassociate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">foreign_model</span><span class="p">,</span> <span class="n">affected_keys</span><span class="p">,</span> <span class="n">via</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">foreign_model</span><span class="p">,</span> <span class="n">via</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">references</span><span class="p">:</span>
                    <span class="c1"># pylint complains because `model` is changing on every iteration so we&#39;ll have</span>
                    <span class="c1"># a different lambda function `test` on each iteration.  This is exactly what</span>
                    <span class="c1"># we want so we disable the warning.</span>
                    <span class="c1"># pylint: disable=cell-var-from-loop, undefined-loop-variable</span>
                    <span class="n">test</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">eid</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">eid</span> <span class="o">==</span> <span class="n">x</span>
                    <span class="n">affected</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">via</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="n">foreign_model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">affected_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">eid</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">affected</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">affected_keys</span><span class="p">:</span>
                        <span class="n">_heavy_debug</span><span class="p">(</span><span class="s2">&quot;Deleting </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">) affects &#39;</span><span class="si">%s</span><span class="s2">&#39; in </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">via</span><span class="p">,</span> <span class="n">foreign_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">affected_keys</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_disassociate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">foreign_model</span><span class="p">,</span> <span class="n">affected_keys</span><span class="p">,</span> <span class="n">via</span><span class="p">)</span>
                <span class="n">removed_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">changing</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">key_attribute</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">key_attribute</span><span class="p">)}</span>
                <span class="n">database</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">changing</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">on_delete</span><span class="p">()</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Controller.import_records"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.import_records">[docs]</a>    <span class="k">def</span> <span class="nf">import_records</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Import data records.</span>

<span class="sd">        TODO: Docs</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Controller.export_records"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller.export_records">[docs]</a>    <span class="k">def</span> <span class="nf">export_records</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export data records.</span>

<span class="sd">        Constructs a dictionary containing records matching `keys` or `eids` and all their</span>
<span class="sd">        associated records.  Association fields (`model` and `collection`) are **not** updated</span>
<span class="sd">        and may contain eids of undefined records.</span>

<span class="sd">        Args:</span>
<span class="sd">            keys (dict): Attributes to match.</span>
<span class="sd">            eids (list): Record identifiers to match.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary of tables containing records.</span>

<span class="sd">        Example:</span>
<span class="sd">        ::</span>

<span class="sd">            {</span>
<span class="sd">             &#39;Brewery&#39;: {100: {&#39;address&#39;: &#39;4615 Hollins Ferry Rd, Halethorpe, MD 21227&#39;,</span>
<span class="sd">                               &#39;brews&#39;: [10, 12, 14]}},</span>
<span class="sd">             &#39;Beer&#39;: {10: {&#39;origin&#39;: 100, &#39;color&#39;: &#39;gold&#39;, &#39;ibu&#39;: 45},</span>
<span class="sd">                      12: {&#39;origin&#39;: 100, &#39;color&#39;: &#39;dark&#39;, &#39;ibu&#39;: 15},</span>
<span class="sd">                      14: {&#39;origin&#39;: 100, &#39;color&#39;: &#39;pale&#39;, &#39;ibu&#39;: 30}}</span>
<span class="sd">            }</span>

<span class="sd">            Beer.export_records(eids=[10])</span>

<span class="sd">            {</span>
<span class="sd">             &#39;Brewery&#39;: {100: {&#39;address&#39;: &#39;4615 Hollins Ferry Rd, Halethorpe, MD 21227&#39;,</span>
<span class="sd">                               &#39;brews&#39;: [10, 12, 14]}},</span>
<span class="sd">             &#39;Beer&#39;: {10: {&#39;origin&#39;: 100, &#39;color&#39;: &#39;gold&#39;, &#39;ibu&#39;: 45}}</span>
<span class="sd">            }</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">export_record</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="ow">and</span> <span class="n">record</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">all_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">eid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">eid</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">data</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">foreign</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">associations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">foreign_record</span> <span class="ow">in</span> <span class="n">foreign</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">eids</span><span class="o">=</span><span class="n">record</span><span class="p">[</span><span class="n">attr</span><span class="p">]):</span>
                        <span class="n">export_record</span><span class="p">(</span><span class="n">foreign_record</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
        <span class="n">all_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">eids</span><span class="p">):</span>
            <span class="n">export_record</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_data</span></div>

<div class="viewcode-block" id="Controller._associate"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller._associate">[docs]</a>    <span class="k">def</span> <span class="nf">_associate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">foreign_model</span><span class="p">,</span> <span class="n">affected</span><span class="p">,</span> <span class="n">via</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Associates a record with another record.</span>

<span class="sd">        Args:</span>
<span class="sd">            record (Record): Record to associate.</span>
<span class="sd">            foreign_model (Model): Foreign record&#39;s data model.</span>
<span class="sd">            affected (list): Identifiers for the records that will be updated to associate with `record`.</span>
<span class="sd">            via (str): The name of the associated foreign attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_heavy_debug</span><span class="p">(</span><span class="s2">&quot;Adding </span><span class="si">%s</span><span class="s2"> to &#39;</span><span class="si">%s</span><span class="s2">&#39; in </span><span class="si">%s</span><span class="s2">(eids=</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">via</span><span class="p">,</span> <span class="n">foreign_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">affected</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">affected</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">affected</span> <span class="o">=</span> <span class="p">[</span><span class="n">affected</span><span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="k">as</span> <span class="n">database</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">affected</span><span class="p">:</span>
                <span class="n">foreign_record</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="n">foreign_model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">foreign_record</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span><span class="n">foreign_model</span><span class="p">,</span> <span class="s2">&quot;No record with ID &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">foreign_model</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">via</span><span class="p">]:</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">eid</span>
                <span class="k">elif</span> <span class="s1">&#39;collection&#39;</span> <span class="ow">in</span> <span class="n">foreign_model</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">via</span><span class="p">]:</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">foreign_record</span><span class="p">[</span><span class="n">via</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">eid</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InternalError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">foreign_model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">via</span><span class="si">}</span><span class="s2"> has neither &#39;model&#39; nor &#39;collection&#39;&quot;</span><span class="p">)</span>
                <span class="n">foreign_model</span><span class="o">.</span><span class="n">controller</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">via</span><span class="p">:</span> <span class="n">updated</span><span class="p">},</span> <span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="Controller._disassociate"><a class="viewcode-back" href="../../../taucmdr.mvc.controller.html#taucmdr.mvc.controller.Controller._disassociate">[docs]</a>    <span class="k">def</span> <span class="nf">_disassociate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">foreign_model</span><span class="p">,</span> <span class="n">affected</span><span class="p">,</span> <span class="n">via</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disassociates a record from another record.</span>

<span class="sd">        Args:</span>
<span class="sd">            record (Record): Record to disassociate.</span>
<span class="sd">            foreign_model (Model): Foreign record&#39;s data model.</span>
<span class="sd">            affected (list): Identifiers for the records that will be updated to disassociate from `record`.</span>
<span class="sd">            via (str): The name of the associated foreign attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_heavy_debug</span><span class="p">(</span><span class="s2">&quot;Removing </span><span class="si">%s</span><span class="s2"> from &#39;</span><span class="si">%s</span><span class="s2">&#39; in </span><span class="si">%s</span><span class="s2">(eids=</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">via</span><span class="p">,</span> <span class="n">foreign_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">affected</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">affected</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">affected</span> <span class="o">=</span> <span class="p">[</span><span class="n">affected</span><span class="p">]</span>
        <span class="n">foreign_props</span> <span class="o">=</span> <span class="n">foreign_model</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">via</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">foreign_props</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;required&#39;</span> <span class="ow">in</span> <span class="n">foreign_props</span><span class="p">:</span>
                <span class="n">_heavy_debug</span><span class="p">(</span><span class="s2">&quot;Empty required attr &#39;</span><span class="si">%s</span><span class="s2">&#39;: deleting </span><span class="si">%s</span><span class="s2">(keys=</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">via</span><span class="p">,</span> <span class="n">foreign_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">affected</span><span class="p">)</span>
                <span class="n">foreign_model</span><span class="o">.</span><span class="n">controller</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">affected</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="k">as</span> <span class="n">database</span><span class="p">:</span>
                    <span class="n">database</span><span class="o">.</span><span class="n">unset</span><span class="p">([</span><span class="n">via</span><span class="p">],</span> <span class="n">affected</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="n">foreign_model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;collection&#39;</span> <span class="ow">in</span> <span class="n">foreign_props</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="k">as</span> <span class="n">database</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">affected</span><span class="p">:</span>
                    <span class="n">foreign_record</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="n">foreign_model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">foreign_record</span><span class="p">[</span><span class="n">via</span><span class="p">])</span> <span class="o">-</span> <span class="p">{</span><span class="n">record</span><span class="o">.</span><span class="n">eid</span><span class="p">})</span>
                    <span class="k">if</span> <span class="s1">&#39;required&#39;</span> <span class="ow">in</span> <span class="n">foreign_props</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">updated</span><span class="p">:</span>
                        <span class="n">_heavy_debug</span><span class="p">(</span><span class="s2">&quot;Empty required attr &#39;</span><span class="si">%s</span><span class="s2">&#39;: deleting </span><span class="si">%s</span><span class="s2">(key=</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">via</span><span class="p">,</span> <span class="n">foreign_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                        <span class="n">foreign_model</span><span class="o">.</span><span class="n">controller</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">database</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">via</span><span class="p">:</span> <span class="n">updated</span><span class="p">},</span> <span class="n">key</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="n">foreign_model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div></div>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2015 ParaTools, Inc..
      Last updated on Jun 30, 2022 at 20:01:18 UTC.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
  </body>
</html>